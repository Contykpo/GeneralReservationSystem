services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver_container
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=${ACCEPT_EULA}
      - MSSQL_SA_PASSWORD=${SA_PASSWORD}
    volumes:
      - sql_data:/var/opt/mssql
      - ./apply-migrations.sh:/apply-migrations.sh
      - ./Migrations:/Migrations
    command: >
        /bin/bash -c "/opt/mssql/bin/sqlservr &
        ./apply-migrations.sh &&
        wait"

  generalreservationsystem.api:  
    build:
      context: .
      dockerfile: GeneralReservationSystem.API/Dockerfile
    ports:
      - "${HOST_API_HTTP_PORT:-5002}:${API_HTTP_PORT:-8080}"
      - "${HOST_API_HTTPS_PORT:-5003}:${API_HTTPS_PORT:-8081}"
    depends_on:
      - sqlserver
    environment:
      - ConnectionStrings__DefaultConnection=Server=${SQL_HOST},${SQL_PORT};Database=${SQL_DB};User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True
      - SQL_HOST=${SQL_HOST}
      - SQL_PORT=${SQL_PORT}
      - SQL_DB=${SQL_DB}
      - SQL_USER=${SQL_USER}
      - SQL_PASSWORD=${SQL_PASSWORD}
      - ASPNETCORE_HTTP_PORTS=${API_HTTP_PORT:-8080}
      - ASPNETCORE_HTTPS_PORTS=${API_HTTPS_PORT:-8081}
      - Jwt__SecretKey=${JWT_SECRET_KEY}
      - CorsOrigins=${CORS_ORIGINS}

  generalreservationsystem.web:  
    build:
      context: .
      dockerfile: GeneralReservationSystem.Web/GeneralReservationSystem.Web/Dockerfile
    ports:
      - "${HOST_APP_HTTP_PORT:-5000}:${APP_HTTP_PORT:-8080}"
      - "${HOST_APP_HTTPS_PORT:-5001}:${APP_HTTPS_PORT:-8081}"
    depends_on:
      - generalreservationsystem.api
    environment:
      - ASPNETCORE_HTTP_PORTS=${APP_HTTP_PORT:-8080}
      - ASPNETCORE_HTTPS_PORTS=${APP_HTTPS_PORT:-8081}

volumes:
  sql_data: