@page "/login"

@using GeneralReservationSystem.Application.DTOs.Authentication
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Web.Client.Authentication
@using GeneralReservationSystem.Web.Client.Services
@using GeneralReservationSystem.Web.Client.Services.Interfaces.Authentication
@using Microsoft.AspNetCore.Components.Authorization

@inject IClientAuthenticationService AuthenticationService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Iniciar sesión</PageTitle>

<AuthorizeView>
    <Authorized>
        <RedirectToHome />
    </Authorized>
    <NotAuthorized>
        @* TODO: Find a better way to center it. The calculation is BAD. *@
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center"
            Class="centered-form-gradient-bg d-flex flex-column flex-fill" Style="min-height: calc(100vh - 64px);">
            <MudPaper Class="pa-4" MaxWidth="300px" Width="100%" Elevation="6">
                <MudText Typo="Typo.h5" Class="mb-4">Iniciar sesión</MudText>
                <MudForm @ref="_form" Spacing="3">
                    <AntiforgeryToken />
                    <MudTextField Label="Usuario o Correo electrónico" For="@(() => _loginDto.UserNameOrEmail)"
                        @bind-Value="_loginDto.UserNameOrEmail" />
                    <MudTextField Label="Contraseña" For="@(() => _loginDto.Password)" @bind-Value="_loginDto.Password"
                        InputType="InputType.Password" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="w-100" OnClick="HandleLogin">
                        Iniciar sesión</MudButton>
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <MudAlert Severity="Severity.Error" Class="mt-3">@_error</MudAlert>
                    }
                </MudForm>
            </MudPaper>
        </MudStack>
    </NotAuthorized>
</AuthorizeView>

@code {
    private LoginDto _loginDto = new();
    private MudForm _form = null!;
    private string _error = string.Empty;

    private async Task HandleLogin()
    {
        _error = string.Empty;
        await _form.Validate();
        if (!_form.IsValid)
            return;
        try
        {
            var user = await AuthenticationService.AuthenticateAsync(_loginDto);
            if (AuthStateProvider is ClientAuthenticationStateProvider custom)
            {
                custom.MarkUserAsAuthenticated(user);
            }
            Navigation.NavigateTo("/");
        }
        catch (ServiceNotFoundException ex)
        {
            _error = ex.Message;
        }
        catch (ServiceBusinessException ex)
        {
            _error = ex.Message;
        }
    }
}