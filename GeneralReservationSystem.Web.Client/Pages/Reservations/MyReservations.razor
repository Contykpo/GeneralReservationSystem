@page "/reservations"

@attribute [Authorize]

@using GeneralReservationSystem.Web.Client.Helpers
@using GeneralReservationSystem.Web.Client.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces

@using AppFilterOperator = GeneralReservationSystem.Application.Common.FilterOperator
@using Severity = MudBlazor.Severity

@inject IClientReservationService ReservationService
@inject IClientStationService StationService
@inject ISnackbar Snackbar

<PageTitle>Mis Reservas</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Mis Reservas</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => _table!.ReloadServerData())"
                    StartIcon="@Icons.Material.Filled.Refresh">Actualizar</MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel Text="Filtros avanzados" Icon="@Icons.Material.Filled.FilterList">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="int?" Label="Estación Salida" Value="_filterDepartureStationId"
                                       ValueChanged="@(async (int? value) => { _filterDepartureStationId = value; await _table!.ReloadServerData(); })"
                                Variant="Variant.Outlined" Clearable="true" Immediate="true">
                                <MudSelectItem T="int?" Value="null">Todas</MudSelectItem>
                                @foreach (var station in _stations)
                                {
                                    <MudSelectItem T="int?" Value="@station.StationId">
                                        @station.StationName, @station.City, @station.Province, @station.Country
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="int?" Label="Estación Llegada" Value="_filterArrivalStationId"
                                       ValueChanged="@(async (int? value) => { _filterArrivalStationId = value; await _table!.ReloadServerData(); })"
                                Variant="Variant.Outlined" Clearable="true" Immediate="true">
                                <MudSelectItem T="int?" Value="null">Todas</MudSelectItem>
                                @foreach (var station in _stations)
                                {
                                    <MudSelectItem T="int?" Value="@station.StationId">
                                        @station.StationName, @station.City, @station.Province, @station.Country
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDateRangePicker DateRange="_filterDepartureDateRange"
                                                DateRangeChanged="@(async (DateRange? range) => { _filterDepartureDateRange = range; await _table!.ReloadServerData(); })"
                                Label="Rango Fecha Salida" Variant="Variant.Outlined" Clearable="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDateRangePicker DateRange="_filterArrivalDateRange"
                                                DateRangeChanged="@(async (DateRange? range) => { _filterArrivalDateRange = range; await _table!.ReloadServerData(); })"
                                Label="Rango Fecha Llegada" Variant="Variant.Outlined" Clearable="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters"
                                StartIcon="@Icons.Material.Filled.Clear">Limpiar Filtros</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudTable @ref="_table" T="UserReservationDetailsDto" ServerData="ServerReload" Loading="@_loading"
                LoadingProgressColor="Color.Primary" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true"
                RowsPerPage="10" SortLabel="TripId" Elevation="0">
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString" Placeholder="Buscar en todos los campos - omite filtros avanzados"
                        Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                        Class="mt-0" Clearable="true"
                        OnClearButtonClick="@(() => { _searchString = string.Empty; _table!.ReloadServerData(); })"
                        Immediate="true" DebounceInterval="300"
                        OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel SortLabel="TripId" T="UserReservationDetailsDto">ID Viaje</MudTableSortLabel>
                    </MudTh>
                    <MudTh>Salida</MudTh>
                    <MudTh>Llegada</MudTh>
                    <MudTh>
                        <MudTableSortLabel SortLabel="Seat" T="UserReservationDetailsDto">Asiento</MudTableSortLabel>
                    </MudTh>
                    <MudTh Style="text-align: right">Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID Viaje">@context.TripId</MudTd>
                    <MudTd DataLabel="Salida">
                        <div>
                            <b>@context.DepartureStationName</b><br />
                            @context.DepartureCity, @context.DepartureProvince, @context.DepartureCountry<br />
                            <span>@context.DepartureTime.ToString("g")</span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Llegada">
                        <div>
                            <b>@context.ArrivalStationName</b><br />
                            @context.ArrivalCity, @context.ArrivalProvince, @context.ArrivalCountry<br />
                            <span>@context.ArrivalTime.ToString("g")</span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Asiento">@context.Seat</MudTd>
                    <MudTd DataLabel="Acciones" Style="text-align: right">
                        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                            OnClick="@(() => HandleDelete(context))" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No se encontraron reservas.</MudText>
                </NoRecordsContent>
                <LoadingContent>
                    <MudText>Cargando...</MudText>
                </LoadingContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private MudTable<UserReservationDetailsDto> _table = null!;
    private bool _loading = false;
    private string _searchString = string.Empty;
    private int? _filterDepartureStationId = null;
    private int? _filterArrivalStationId = null;
    private DateRange? _filterDepartureDateRange = null;
    private DateRange? _filterArrivalDateRange = null;
    private List<Station> _stations = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _stations = (await StationService.GetAllStationsAsync()).ToList();
        }
        catch
        {
            Snackbar.Add("Error al cargar las estaciones.", Severity.Error);
        }
    }

    private async Task<TableData<UserReservationDetailsDto>> ServerReload(TableState state, CancellationToken
        cancellationToken)
    {
        _loading = true;
        try
        {
            var searchRequest = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize,
                FilterClauses = BuildFilterClauses(state),
                Orders = TableHelpers.BuildOrders(state)
            };

            var result = await ReservationService.SearchCurrentUserReservationsAsync(searchRequest, cancellationToken);
            return new TableData<UserReservationDetailsDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (OperationCanceledException)
        {
            // Ignore cancellation
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error al cargar reservas.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }

        return new TableData<UserReservationDetailsDto> { Items = [], TotalItems = 0 };
    }

    private IEnumerable<FilterClause> BuildFilterClauses(TableState state)
    {
        var filterClauses = new List<FilterClause>();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            var searchFilters = new List<Filter>
            {
                new Filter("DepartureStationName", AppFilterOperator.Contains, _searchString),
                new Filter("ArrivalStationName", AppFilterOperator.Contains, _searchString),
                new Filter("DepartureCity", AppFilterOperator.Contains, _searchString),
                new Filter("ArrivalCity", AppFilterOperator.Contains, _searchString),
                new Filter("DepartureProvince", AppFilterOperator.Contains, _searchString),
                new Filter("ArrivalProvince", AppFilterOperator.Contains, _searchString),
                new Filter("DepartureCountry", AppFilterOperator.Contains, _searchString),
                new Filter("ArrivalCountry", AppFilterOperator.Contains, _searchString)
            };
            filterClauses.Add(new FilterClause(searchFilters));
        }
        else
        {
            if (_filterDepartureStationId.HasValue)
            {
                filterClauses.Add(new FilterClause([
                    new Filter("DepartureStationId", AppFilterOperator.Equals, _filterDepartureStationId.Value)
                ]));
            }
            
            if (_filterArrivalStationId.HasValue)
            {
                filterClauses.Add(new FilterClause([
                    new Filter("ArrivalStationId", AppFilterOperator.Equals, _filterArrivalStationId.Value)
                ]));
            }
            
            if (_filterDepartureDateRange?.Start != null && _filterDepartureDateRange?.End != null)
            {
                filterClauses.Add(new FilterClause([
                    new Filter("DepartureTime", AppFilterOperator.Between, 
                        new object[] { _filterDepartureDateRange.Start.Value, _filterDepartureDateRange.End.Value })
                ]));
            }
            
            if (_filterArrivalDateRange?.Start != null && _filterArrivalDateRange?.End != null)
            {
                filterClauses.Add(new FilterClause([
                    new Filter("ArrivalTime", AppFilterOperator.Between, 
                        new object[] { _filterArrivalDateRange.Start.Value, _filterArrivalDateRange.End.Value })
                ]));
            }
        }

        return filterClauses;
    }

    private void ClearFilters()
    {
        _filterDepartureStationId = null;
        _filterArrivalStationId = null;
        _filterDepartureDateRange = null;
        _filterArrivalDateRange = null;
        _searchString = string.Empty;
        _table!.ReloadServerData();
    }

    private async Task HandleDelete(UserReservationDetailsDto item)
    {
        try
        {
            await ReservationService.DeleteReservationAsync(new ReservationKeyDto
            {
                TripId =
            item.TripId,
                Seat = item.Seat
            });
            Snackbar.Add("Reserva eliminada.", Severity.Success);
            await _table.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await _table.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error inesperado.", Severity.Error);
        }
    }
}
