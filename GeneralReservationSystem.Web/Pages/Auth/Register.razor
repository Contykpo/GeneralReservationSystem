@page "/authentication/register"

@using GeneralReservationSystem.Application.DTOs.Authentication
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Web.Authentication
@using GeneralReservationSystem.Web.Services
@using GeneralReservationSystem.Web.Services.Interfaces.Authentication

@inject IClientAuthenticationService ClientAuthenticationService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView>
    <Authorized>
        <RedirectToHome />
    </Authorized>
    <NotAuthorized>
        <MudContainer Class="mt-16">
            <MudGrid Class="mt-16" Justify="Justify.Center">
                <MudItem xs="12" sm="12" md="4">
                    <MudCard Elevation="25" Class="rounded-lg pb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h5" Align="Align.Center">Registrarse</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudForm Model="@_registerDto" @ref="@_form" Validation="@(registerValidator.ValidateValue)" ValidationDelay="0">
                                <MudCardContent>
                                    <MudTextField @bind-Value="_registerDto.UserName"
                                                  For="@(() => _registerDto.UserName)"
                                                  Required="true"
                                                  Label="Nombre" />

                                    <MudTextField @bind-Value="_registerDto.Email"
                                                  For="@(() => _registerDto.Email)"
                                                  Required="true"
                                                  Label="Email" />

                                    <MudTextField @bind-Value="_registerDto.Password"
                                                  For="@(() => _registerDto.Password)"
                                                  InputType="InputType.Password"
                                                  Required="true"
                                                  Label="Contraseña" />

                                    <MudTextField @bind-Value="_registerDto.ConfirmPassword"
                                                  For="@(() => _registerDto.ConfirmPassword)"
                                                  InputType="InputType.Password"
                                                  Required="true"
                                                  Label="Confirme la contraseña" />
                                </MudCardContent>
                            </MudForm>
                        </MudCardContent>
                        <MudCardActions Class="d-flex justify-center">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Style="width:50%;" OnClick="@(async () => await RegisterAsync())">Registrarse</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            </MudGrid>
            <MudText Align="Align.Center" Class="mt-4">
                ¿Ya esta registrado?
                <MudLink Href="/authentication/login" Align="Align.Center">Loguearse</MudLink>
            </MudText>
        </MudContainer>
    </NotAuthorized>
</AuthorizeView>

@code
{
    private RegisterUserDto _registerDto = new();
    
    private MudForm _form = null!;
    
    private RegisterValidator registerValidator = new RegisterValidator();

    private string _error = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task RegisterAsync()
    {
        _error = string.Empty;
        await _form.Validate();
        if (!_form.IsValid)
            return;
        try
        {
            var user = await ClientAuthenticationService.RegisterUserAsync(_registerDto);
            if (AuthStateProvider is CustomAuthenticationStateProvider custom)
            {
                custom.MarkUserAsAuthenticated(user);
            }
            Navigation.NavigateTo("/");
        }
        catch (ServiceBusinessException ex)
        {
            _error = ex.Message;
        }
    }

    /// <summary>
    /// A standard AbstractValidator which contains multiple rules and can be shared with the back end API.
    /// </summary>
    /// <typeparam name="registerUser"></typeparam>
    public class RegisterValidator : AbstractValidator<RegisterUserDto>
    {
        public RegisterValidator()
        {
            RuleFor(r => r.UserName)
                .NotEmpty().WithMessage("El nombre de usuario es obligatorio.")
                .Length(1, 50).WithMessage("El nombre de usuario debe tener entre 1 y 50 caracteres.");
            RuleFor(r => r.Email)
                .Cascade(CascadeMode.Stop)
                .NotEmpty().WithMessage("El correo electrónico es obligatorio.")
                .EmailAddress().WithMessage("El correo electrónico no es válido.")
                .MustAsync(async (value, cancellationToken) => await IsUniqueAsync(value)).WithMessage("El correo electrónico ya está registrado.");
            RuleFor(r => r.Password)
                .NotEmpty().WithMessage("La contraseña no puede estar vacía.")
                .MinimumLength(8).WithMessage("La contraseña debe tener al menos 8 caracteres.")
                .Matches(@"[A-Z]+").WithMessage("La contraseña debe contener al menos una letra mayúscula.")
                .Matches(@"[a-z]+").WithMessage("La contraseña debe contener al menos una letra minúscula.")
                .Matches(@"[0-9]+").WithMessage("La contraseña debe contener al menos un número.")
                .Matches(@"[\#\?\!\@\$\%\^\&\*\-\.]+").WithMessage("La contraseña debe contener al menos un carácter especial: #?!@$ %^&*-. ");
            RuleFor(r => r.ConfirmPassword)
                .Equal(r => r.Password).WithMessage("Las contraseñas no coinciden.");
        }

        private async Task<bool> IsUniqueAsync(string email)
        {
            // Simulates a long running http call.
            await Task.Delay(2000);

            return email.ToLower() != "test@test.com";
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<RegisterUserDto>.CreateWithOptions((RegisterUserDto)model, x => x.IncludeProperties(propertyName)));

            if (result.IsValid) return Array.Empty<string>();

            return result.Errors.Select(e => e.ErrorMessage);
        };
    }

}
