@page "/stations"

@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Services.Interfaces

@inject IStationService StationService
@inject ISnackbar Snackbar


<PageTitle>Stations Administration</PageTitle>

<MudPaper Class="pa-4 mx-auto mt-4" MaxWidth="900px">
    <MudText Typo="Typo.h5" GutterBottom="true">Administrar Estaciones</MudText>

    <MudForm Model="@station" @ref="form" Validation="@(new StationValidator().ValidateValue)">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="station.StationName" Label="Nombre de estación" For="@(() => station.StationName)" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="station.Address" Label="Dirección" For="@(() => station.Address)" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="station.City" Label="Ciudad" For="@(() => station.City)" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="station.Province" Label="Provincia" For="@(() => station.Province)" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="station.Country" Label="País" For="@(() => station.Country)" Required="true" />
            </MudItem>

            <MudItem xs="12" sm="6" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitAsync">
                    @(isEditMode ? "Editar" : "Crear")
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2" OnClick="ResetForm">
                    Limpiar
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudPaper>

<MudPaper Class="pa-4 mx-auto mt-4" MaxWidth="900px">
    <MudTable Items="@stations" Hover="true" Dense="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Estaciones</MudText>
            <MudSpacer />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>Nombre</MudTh>
            <MudTh>Dirección</MudTh>
            <MudTh>Ciudad</MudTh>
            <MudTh>Provincia</MudTh>
            <MudTh>País</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            @*TODO: Modificar para que no muestre id de las estaciones, sino el nombre*@
            <MudTd DataLabel="Id">@context.StationId</MudTd>
            <MudTd DataLabel="Nombre">@context.StationName</MudTd>
            <MudTd DataLabel="Dirección">@context.Address</MudTd>
            <MudTd DataLabel="Ciudad">@context.City</MudTd>
            <MudTd DataLabel="Provincia">@context.Province</MudTd>
            <MudTd DataLabel="País">@context.Country</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="@(() => EditStation(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteStation(context.StationId))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudPaper>


@code
{
    List<Station>? stations = new List<Station>();

    MudForm form;

	Station station = new();

    bool isEditMode = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadStationsAsync();
    }
    
    private async Task LoadStationsAsync()
    {
        //TODO: Deberiamos paginar en el futuro.
        stations = (await StationService.GetAllStationsAsync()).ToList();
    }

    private async Task SubmitAsync()
    {
        await form!.Validate();
        if (!form.IsValid)
        {
            Snackbar.Add("Por favor, corrige los errores del formulario.", MudBlazor.Severity.Warning);
            return;
        }

        try
        {
            if (isEditMode)
            {
                await StationService.UpdateStationAsync(station);
                Snackbar.Add("Estación actualizada correctamente.", MudBlazor.Severity.Success);
            }
            else
            {
                await StationService.CreateStationAsync(station);
                Snackbar.Add("Estación creada correctamente.", MudBlazor.Severity.Success);
            }

            await LoadStationsAsync();
            
            ResetForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private void EditStation(Station selectedStation)
    {
        station = new Station
        {
            StationId = selectedStation.StationId,
            StationName = selectedStation.StationName,
            Address = selectedStation.Address,
            City = selectedStation.City,
            Province = selectedStation.Province,
            Country = selectedStation.Country
        };
        isEditMode = true;
    }

    private async Task DeleteStation(int stationId)
    {
        bool confirmed = await Task.FromResult(true);
        if (!confirmed)
            return;

        try
        {
            await StationService.DeleteStationAsync(stationId);
            Snackbar.Add("Estación eliminada correctamente.", MudBlazor.Severity.Info);
            await LoadStationsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async void ResetForm()
    {
        station = new Station();
        isEditMode = false;
        await form.ResetAsync();
    }

    /// <summary>
    /// A standard AbstractValidator which contains multiple rules and can be shared with the back end API.
    /// </summary>
    /// <typeparam name="station"></typeparam>
    public class StationValidator : AbstractValidator<Station>
    {
        public StationValidator()
        {
            RuleFor(x => x.StationName)
                .NotEmpty().WithMessage("El nombre de la estación es obligatorio.")
                .Length(2, 100).WithMessage("El nombre debe tener entre 2 y 100 caracteres.")
                .Matches(@"^[\p{L}\s'-]+$").WithMessage("Solo puede contener letras, espacios, apóstrofes o guiones.");

            RuleFor(x => x.Address)
                .NotEmpty().WithMessage("La dirección es obligatoria.")
                .Length(2, 50).Matches(@"^[\p{L}\s'-]+$");

            RuleFor(x => x.City)
                .NotEmpty().WithMessage("La ciudad es obligatoria.")
                .Length(2, 50).Matches(@"^[\p{L}\s'-]+$");

            RuleFor(x => x.Province)
                .NotEmpty().WithMessage("La provincia es obligatoria.")
                .Length(2, 50).Matches(@"^[\p{L}\s'-]+$");

            RuleFor(x => x.Country)
                .NotEmpty().WithMessage("El país es obligatorio.")
                .Length(2, 50).Matches(@"^[\p{L}\s'-]+$");
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<Station>.CreateWithOptions((Station)model, x => x.IncludeProperties(propertyName)));

            if (result.IsValid) return Array.Empty<string>();

            return result.Errors.Select(e => e.ErrorMessage);
        };
    }
}
