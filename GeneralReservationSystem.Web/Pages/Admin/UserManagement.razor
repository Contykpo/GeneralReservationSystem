@page "/admin/users"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.DTOs.Authentication
@using GeneralReservationSystem.Application.Entities.Authentication
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces.Authentication
@inject IUserService UserService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <PageTitle>Gestión de Usuarios</PageTitle>

    <MudDataGrid @ref="dataGrid"
                 T="UserInfo"
                 ServerData="ServerReload"
                 Filterable="true"
                 SortMode="SortMode.Multiple"
                 EditMode="DataGridEditMode.Form"
                 EditTrigger="DataGridEditTrigger.Manual"
                 CommittedItemChanges="HandleCommit"
                 StartedEditingItem="HandleStartedEditingItem"
                 ReadOnly="false"
                 RowsPerPage="10">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Usuarios</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => dataGrid.ReloadServerData())" StartIcon="@Icons.Material.Filled.Refresh">Actualizar</MudButton>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.UserId" Title="ID" Editable="false" />
            <PropertyColumn Property="x => x.UserName" Title="Usuario">
                <EditTemplate>
                    <MudTextField Label="Usuario" 
                                  @bind-Value="_editUserDto.UserName" 
                                  For="@(() => _editUserDto.UserName)"
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense" 
                                  Immediate="true" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Email" Title="Correo">
                <EditTemplate>
                    <MudTextField Label="Correo" 
                                  @bind-Value="_editUserDto.Email" 
                                  For="@(() => _editUserDto.Email)"
                                  Variant="Variant.Outlined" 
                                  Margin="Margin.Dense" 
                                  Immediate="true" />
                </EditTemplate>
            </PropertyColumn>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => context.Actions.StartEditingItemAsync())" />
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDelete(context.Item))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="UserInfo" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
private MudDataGrid<UserInfo> dataGrid = null!;
private UpdateUserDto _editUserDto = new();

private async Task<GridData<UserInfo>> ServerReload(GridState<UserInfo> state)
    {
        try
        {
            var search = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize
            };
            var result = await UserService.SearchUsersAsync(search);
            return new GridData<UserInfo> { Items = result.Items, TotalItems = result.TotalCount };
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error al cargar usuarios.", Severity.Error);
        }
        return new GridData<UserInfo> { Items = Array.Empty<UserInfo>(), TotalItems = 0 };
    }

    private void HandleStartedEditingItem(UserInfo item)
    {
        _editUserDto = new UpdateUserDto
        {
            UserId = item.UserId,
            UserName = item.UserName,
            Email = item.Email
        };
    }

    private async Task HandleCommit(UserInfo item)
    {
        try
        {
            await UserService.UpdateUserAsync(_editUserDto);
            Snackbar.Add("Usuario actualizado.", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error inesperado.", Severity.Error);
        }
    }

    private async Task HandleDelete(UserInfo item)
    {
        try
        {
            await UserService.DeleteUserAsync(new UserKeyDto { UserId = item.UserId });
            Snackbar.Add("Usuario eliminado.", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error inesperado.", Severity.Error);
        }
    }
}
