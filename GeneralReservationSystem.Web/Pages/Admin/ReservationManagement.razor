@page "/admin/reservations"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces
@inject IReservationService ReservationService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <PageTitle>Gestión de Reservas</PageTitle>

    <MudDataGrid @ref="dataGrid"
                 T="Reservation"
                 ServerData="ServerReload"
                 RowsPerPage="10">
        <Columns>
            <PropertyColumn Property="x => x.TripId" Title="Viaje" />
            <PropertyColumn Property="x => x.UserId" Title="Usuario" />
            <PropertyColumn Property="x => x.Seat" Title="Asiento" />
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDelete(context.Item))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Reservation" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
    private MudDataGrid<Reservation> dataGrid = null!;

    private async Task<GridData<Reservation>> ServerReload(GridState<Reservation> state)
    {
        try
        {
            var search = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize
            };
            var result = await ReservationService.SearchReservationsAsync(search);
            return new GridData<Reservation> { Items = result.Items, TotalItems = result.TotalCount };
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error al cargar reservas.", Severity.Error);
        }
        return new GridData<Reservation> { Items = Array.Empty<Reservation>(), TotalItems = 0 };
    }

    private async Task HandleDelete(Reservation item)
    {
        try
        {
            await ReservationService.DeleteReservationAsync(new ReservationKeyDto { TripId = item.TripId, UserId = item.UserId });
            Snackbar.Add("Reserva eliminada.", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error inesperado.", Severity.Error);
        }
    }
}
