@page "/Account/Register"

@* TODO: Debo arreglarlo, paciencia *@
@*@using GeneralReservationSystem.Application.Entities.Authentication
@using GeneralReservationSystem.Application.Repositories.Interfaces.Authentication
@using GeneralReservationSystem.Web.Helpers
@using System.Text
@inject IUserRepository UserRepository
@inject IRoleRepository RoleRepository
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudContainer Class="mt-16">
    <MudGrid Class="mt-16" Justify="Justify.Center">
        <MudItem xs="12" sm="12" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5" Align="Align.Center">Registrarse</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudForm Model="@registerUserData" @ref="@form" Validation="@(registerValidator.ValidateValue)" ValidationDelay="0">
                        <MudCardContent>
                            <MudTextField @bind-Value="registerUserData.UserName"
                                          For="@(() => registerUserData.UserName)"
                                          Required="true"
                                          Label="Nombre" />

                            <MudTextField @bind-Value="registerUserData.Email"
                                          For="@(() => registerUserData.Email)"
                                          Required="true"
                                          Label="Email" />

                            <MudTextField @bind-Value="registerUserData.Password"
                                          For="@(() => registerUserData.Password)"
                                          InputType="InputType.Password"
                                          Required="true"
                                          Label="Contraseña" />

                            <MudTextField @bind-Value="registerUserData.ConfirmPassword"
                                          For="@(() => registerUserData.ConfirmPassword)"
                                          InputType="InputType.Password"
                                          Required="true"
                                          Label="Confirme la contraseña" />
                        </MudCardContent>
                    </MudForm>
                </MudCardContent>
                <MudCardActions Class="d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Style="width:50%;" OnClick="@(async () => await RegisterAsync())">Registrarse</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
    <MudText Align="Align.Center" Class="mt-4">
        ¿Ya esta registrado?
        <MudLink Href="/Account/Login" Align="Align.Center">Loguearse</MudLink>
    </MudText>
</MudContainer>

@code
{
    MudForm form;

    ApplicationUser registerUser = new();

    ApplicationUserInputData registerUserData = new();

    RegisterValidator registerValidator = new RegisterValidator();

    private async Task RegisterAsync()
    {
        try
        {
            await form.Validate();

            if (!form.IsValid) return;

            var email = registerUserData.Email.Trim();
            if (await UserRepository.ExistsWithEmailAsync(email))
            {
                Snackbar.Add("Ya existe un usuario registrado con ese correo.", MudBlazor.Severity.Warning);
                return;
            }

            var passwordHasher = new PasswordHashingHelper<ApplicationUser>();
            string hashedPassword = passwordHasher.HashPassword(registerUser, registerUserData.Password);

            registerUser = new ApplicationUser
            {
                UserId = Guid.NewGuid(),
                UserName = registerUserData.UserName,
                NormalizedUserName = registerUserData.UserName.ToUpperInvariant(),
                Email = email,
                NormalizedEmail = email.ToUpperInvariant(),
                EmailConfirmed = false,
                PasswordHash = Encoding.UTF8.GetBytes(hashedPassword),
                SecurityStamp = Guid.NewGuid()
            };

            var rows = await UserRepository.CreateAsync(registerUser);

            if (rows > 0)
            {
                result.IfSuccess(async () =>
                {
                    // TODO: Might want to make IfSuccess async in the future, so that we can show some message for a few seconds before redirecting.
                    // Snackbar.Add("¡Usuario creado exitosamente!", MudBlazor.Severity.Success);
                    await Task.Delay(2000);
                    NavigationManager.NavigateTo("/Account/Login", forceLoad: true);
                })
                .IfFailure(error =>
                {
                    Snackbar.Add($"No se pudo crear el usuario: {error}", MudBlazor.Severity.Error);
                });
            }

            Snackbar.Add("No se pudo crear el usuario.", MudBlazor.Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Se produjo un error: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    public class ApplicationUserInputData
    {
        public string UserName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class RegisterValidator : AbstractValidator<ApplicationUserInputData>
    {
        public RegisterValidator()
        {
            RuleFor(r => r.UserName)
                .NotEmpty().WithMessage("El nombre de usuario es obligatorio.")
                .Length(1, 50).WithMessage("El nombre de usuario debe tener entre 1 y 50 caracteres.");

            RuleFor(r => r.Email)
                .Cascade(CascadeMode.Stop)
                .NotEmpty().WithMessage("El correo electrónico es obligatorio.")
                .EmailAddress().WithMessage("El correo electrónico no es válido.");

            RuleFor(r => r.Password)
                .NotEmpty().WithMessage("La contraseña no puede estar vacía.")
                .MinimumLength(8).WithMessage("La contraseña debe tener al menos 8 caracteres.")
                .Matches(@"[A-Z]+").WithMessage("La contraseña debe contener al menos una letra mayúscula.")
                .Matches(@"[a-z]+").WithMessage("La contraseña debe contener al menos una letra minúscula.")
                .Matches(@"[0-9]+").WithMessage("La contraseña debe contener al menos un número.")
                .Matches(@"[\#\?\!\@\$\%\^\&\*\-\.]+").WithMessage("La contraseña debe contener al menos un carácter especial: #?!@$ %^&*-.");

            RuleFor(r => r.ConfirmPassword)
                .Equal(r => r.Password).WithMessage("Las contraseñas no coinciden.");
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<ApplicationUserInputData>.CreateWithOptions((ApplicationUserInputData)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid) return Array.Empty<string>();
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }
}*@