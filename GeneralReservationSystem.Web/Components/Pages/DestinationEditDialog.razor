@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Services.Interfaces
@using MudBlazor
@using Microsoft.AspNetCore.Components
@using GeneralReservationSystem.Web.Components.Shared
@inject IDestinationService DestinationService
@inject ISnackbar Snackbar
@inject MudBlazor.IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Editar Destino</MudText>
        <MudDivider Class="mb-2" />
        @if (!string.IsNullOrWhiteSpace(lastErrorMessage))
        {
            <MudAlert Severity="MudBlazor.Severity.Error" Elevation="2" Class="mb-2">@lastErrorMessage</MudAlert>
        }
        <EditForm Model="editDestination" OnValidSubmit="UpdateDestinationAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <MudGrid>
                <MudItem xs="12" sm="6" md="4">
                    <MudTextField @bind-Value="editDestination.Name" Label="Nombre" Required="true" Variant="Variant.Outlined" Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudTextField @bind-Value="editDestination.Code" Label="Código" Required="true" Variant="Variant.Outlined" Dense="true" />
                </MudItem>
                <MudItem xs="12">
                    <DestinationLocationSelector
                        @bind-Country="editDestination.Country"
                        @bind-Region="editDestination.Region"
                        @bind-City="editDestination.City"
                        @bind-TimeZone="editDestination.TimeZone" />
                </MudItem>
                <MudItem xs="12">
                    <div class="d-flex justify-end">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Guardar</MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel">Cancelar</MudButton>
                    </div>
                </MudItem>
            </MudGrid>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public UpdateDestinationDto editDestination { get; set; }
    bool isEditValid = true;
    private string? lastErrorMessage;

    private async Task UpdateDestinationAsync()
    {
        lastErrorMessage = null;
        var result = await DestinationService.UpdateDestinationAsync(editDestination);
        result.IfSuccess(() =>
        {
            Snackbar.Add("Destino actualizado", MudBlazor.Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        })
        .IfFailure(error => {
            lastErrorMessage = error ?? "No se pudo actualizar el destino";
            Snackbar.Add(lastErrorMessage, MudBlazor.Severity.Error);
            StateHasChanged();
        });
    }

    void Cancel()
    {
        MudDialog.Cancel();
    }
}
