@page "/Admin/Destinations/Edit/{id:int}"

@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Services.Interfaces
@using GeneralReservationSystem.Application.DTOs

@inject IDestinationService DestinationService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Editar Destino</PageTitle>

<MudPaper Class="mt-4 p-4">
    <MudText Typo="Typo.h5">Editar Destino</MudText>
    <MudDivider Class="mb-4" />
    @if (!string.IsNullOrWhiteSpace(lastErrorMessage))
    {
        <MudAlert Severity="MudBlazor.Severity.Error" Elevation="2" Class="mb-4">@lastErrorMessage</MudAlert>
    }
    <MudForm @ref="editForm" Model="editDestination" Valid="isEditValid">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="editDestination.Name" Label="Nombre" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="editDestination.Code" Label="Código" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="editDestination.City" Label="Ciudad" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="editDestination.Region" Label="Región" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="editDestination.Country" Label="País" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="TimeZoneInfo" @bind-Value="editDestination.TimeZone" Label="Zona Horaria" Required="true">
                    @foreach (var tz in TimeZoneInfo.GetSystemTimeZones())
                    {
                        <MudSelectItem Value="@tz">@tz.DisplayName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UpdateDestinationAsync" Disabled="!isEditValid">Guardar Cambios</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="GoBack">Volver</MudButton>
    </MudForm>
</MudPaper>

@code {
    [Parameter] public int id { get; set; }
    [Parameter, SupplyParameterFromQuery] public int pageIndex { get; set; } = 0;
    [Parameter, SupplyParameterFromQuery] public int pageSize { get; set; } = 10;
    [Parameter, SupplyParameterFromQuery] public string searchName { get; set; } = "";
    [Parameter, SupplyParameterFromQuery] public string searchCode { get; set; } = "";
    [Parameter, SupplyParameterFromQuery] public string searchCity { get; set; } = "";
    [Parameter, SupplyParameterFromQuery] public string searchRegion { get; set; } = "";
    [Parameter, SupplyParameterFromQuery] public string searchCountry { get; set; } = "";
    MudForm editForm;
    UpdateDestinationDto editDestination = new();
    bool isEditValid = true;
    private string? lastErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        var result = await DestinationService.GetDestinationByIdAsync(id);
        result.Match(
            onValue: dest =>
            {
                editDestination.Id = id;
                editDestination.Name = dest.Name;
                editDestination.Code = dest.Code;
                editDestination.City = dest.City;
                editDestination.Region = dest.Region;
                editDestination.Country = dest.Country;
                editDestination.TimeZone = dest.TimeZone;
            },
            onEmpty: () => NavigationManager.NavigateTo("/destinations"),
            onError: error => NavigationManager.NavigateTo("/destinations")
        );
    }

    async Task UpdateDestinationAsync()
    {
        lastErrorMessage = null;
        var result = await DestinationService.UpdateDestinationAsync(editDestination);
        result.IfSuccess(() =>
        {
            Snackbar.Add("Destino actualizado", MudBlazor.Severity.Success);
            GoBack();
        })
        .IfFailure(error => {
            lastErrorMessage = error ?? "No se pudo actualizar el destino";
            Snackbar.Add(lastErrorMessage, MudBlazor.Severity.Error);
            StateHasChanged();
        });
    }

    void GoBack()
    {
        // Return to management page with previous query parameters
        var queryParams = new Dictionary<string, object?>
        {
            [nameof(pageIndex)] = pageIndex,
            [nameof(pageSize)] = pageSize,
            [nameof(searchName)] = string.IsNullOrWhiteSpace(searchName) ? null : searchName,
            [nameof(searchCode)] = string.IsNullOrWhiteSpace(searchCode) ? null : searchCode,
            [nameof(searchCity)] = string.IsNullOrWhiteSpace(searchCity) ? null : searchCity,
            [nameof(searchRegion)] = string.IsNullOrWhiteSpace(searchRegion) ? null : searchRegion,
            [nameof(searchCountry)] = string.IsNullOrWhiteSpace(searchCountry) ? null : searchCountry
        };
        var uri = NavigationManager.GetUriWithQueryParameters("/Admin/Destinations", queryParams);
        NavigationManager.NavigateTo(uri);
    }
}
