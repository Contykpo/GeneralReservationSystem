@page "/Admin/Destinations"

@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Services.Interfaces
@using GeneralReservationSystem.Application.DTOs
@using System.ComponentModel.DataAnnotations
@using ValidationResult = System.ComponentModel.DataAnnotations.ValidationResult
@using Severity = MudBlazor.Severity

@inject IDestinationService DestinationService
@inject ISnackbar Snackbar

<PageTitle>Gestión de Destinos</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Gestión de Destinos</MudText>

    <MudExpansionPanels Class="mb-4">
        <MudExpansionPanel Text="Agregar Nuevo Destino" Icon="@Icons.Material.Filled.Add">
            <MudCard Class="pd-2">
                <MudCardContent>
                    <MudForm Model="@createModel" @ref="createForm" Validation="ValidateCreateModel">
                        <MudGrid>
                            <MudItem xs="12" sm="6" md="4">
                                <MudTextField @bind-Value="createModel.Name" Label="Nombre" Variant="Variant.Outlined" For="@(() => createModel.Name)" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="4">
                                <MudTextField @bind-Value="createModel.Code" Label="Código" Variant="Variant.Outlined" For="@(() => createModel.Code)" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="4">
                                <MudTextField @bind-Value="createModel.City" Label="Ciudad" Variant="Variant.Outlined" For="@(() => createModel.City)" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="4">
                                <MudTextField @bind-Value="createModel.Region" Label="Región" Variant="Variant.Outlined" For="@(() => createModel.Region)" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="4">
                                <MudTextField @bind-Value="createModel.Country" Label="País" Variant="Variant.Outlined" For="@(() => createModel.Country)" Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="4">
                                <MudSelect @bind-Value="createModel.TimeZone" Label="Zona Horaria" Variant="Variant.Outlined" For="@(() => createModel.TimeZone)" T="TimeZoneInfo" ToStringFunc="@(tz => tz?.DisplayName ?? string.Empty)">
                                    @foreach (var tz in TimeZoneInfo.GetSystemTimeZones())
                                    {
                                        <MudSelectItem Value="@tz">@tz.DisplayName</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>
                    </MudForm>
                </MudCardContent>
                <MudCardActions Class="gap-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleCreateDestination" StartIcon="@Icons.Material.Filled.Save">Guardar</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearCreateForm">Limpiar</MudButton>
                </MudCardActions>
            </MudCard>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <MudDataGrid @ref="dataGrid" 
                 T="DestinationEditModel" 
                 ServerData="ServerReload" 
                 Filterable="true" 
                 FilterMode="DataGridFilterMode.ColumnFilterMenu" 
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" 
                 SortMode="SortMode.Multiple" 
                 EditMode="DataGridEditMode.Form" 
                 EditTrigger="DataGridEditTrigger.Manual" 
                 CommittedItemChanges="HandleCommittedItemChanges" 
                 CanceledEditingItem="HandleCanceledEditingItem" 
                 ReadOnly="false" 
                 EditDialogOptions="editDialogOptions"
                 RowsPerPage="10">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Destinos</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => dataGrid.ReloadServerData())" StartIcon="@Icons.Material.Filled.Refresh">Actualizar</MudButton>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.DestinationId" Title="ID" Sortable="true" Filterable="false" Editable="false" />
            <PropertyColumn Property="x => x.Name" Title="Nombre" Sortable="true" Filterable="true">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.Name" Label="Nombre" Required="true" RequiredError="El nombre es obligatorio." Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" Validation="@(new Func<string, IEnumerable<string>>(value => ValidateProperty(nameof(UpdateDestinationDto.Name), value)))" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Code" Title="Código" Sortable="true" Filterable="true">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.Code" Label="Código" Required="true" RequiredError="El código es obligatorio." Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" Validation="@(new Func<string, IEnumerable<string>>(value => ValidateProperty(nameof(UpdateDestinationDto.Code), value)))" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.City" Title="Ciudad" Sortable="true" Filterable="true">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.City" Label="Ciudad" Required="true" RequiredError="La ciudad es obligatoria." Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" Validation="@(new Func<string, IEnumerable<string>>(value => ValidateProperty(nameof(UpdateDestinationDto.City), value)))" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Region" Title="Región" Sortable="true" Filterable="true">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.Region" Label="Región" Required="true" RequiredError="La región es obligatoria." Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" Validation="@(new Func<string, IEnumerable<string>>(value => ValidateProperty(nameof(UpdateDestinationDto.Region), value)))" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Country" Title="País" Sortable="true" Filterable="true">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.Country" Label="País" Required="true" RequiredError="El país es obligatorio." Variant="Variant.Outlined" Margin="Margin.Dense" Immediate="true" Validation="@(new Func<string, IEnumerable<string>>(value => ValidateProperty(nameof(UpdateDestinationDto.Country), value)))" />
                </EditTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Zona Horaria" CellClass="text-end text-md-start" Sortable="false" Filterable="false">
                <CellTemplate>
                    @context.Item.TimeZoneDisplayName
                </CellTemplate>
                <EditTemplate>
                    <MudSelect @bind-Value="context.Item.TimeZoneId" Label="Zona Horaria" Variant="Variant.Outlined" Required="true" RequiredError="La zona horaria es obligatoria." T="string" Margin="Margin.Dense" Immediate="true">
                        @foreach (var tz in TimeZoneInfo.GetSystemTimeZones())
                        {
                            <MudSelectItem Value="@tz.Id">@tz.DisplayName</MudSelectItem>
                        }
                    </MudSelect>
                </EditTemplate>
            </TemplateColumn>
            <TemplateColumn CellClass="w-auto text-nowrap text-md-center justify-end align-center" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => context.Actions.StartEditingItemAsync())" />
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDeleteDestination(context.Item))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="DestinationEditModel" PageSizeOptions="new int[] { 5, 10, 25, 50, 100 }" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
    private MudDataGrid<DestinationEditModel> dataGrid = null!;
    private MudForm createForm = null!;
    private CreateDestinationDto createModel = new();

    private DialogOptions editDialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseButton = true,
        Position = DialogPosition.Center,
        CloseOnEscapeKey = true
    };

    public class DestinationEditModel
    {
        public int DestinationId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string Region { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string TimeZoneId { get; set; } = TimeZoneInfo.Utc.Id;
        public string TimeZoneDisplayName => TimeZoneInfo.FindSystemTimeZoneById(TimeZoneId).DisplayName;

        public static DestinationEditModel FromDestination(Destination destination) => new()
        {
            DestinationId = destination.DestinationId,
            Name = destination.Name,
            Code = destination.Code,
            City = destination.City,
            Region = destination.Region,
            Country = destination.Country,
            TimeZoneId = destination.TimeZone?.Id ?? TimeZoneInfo.Utc.Id
        };

        public UpdateDestinationDto ToUpdateDto() => new()
        {
            DestinationId = DestinationId,
            Name = Name,
            Code = Code,
            City = City,
            Region = Region,
            Country = Country,
            TimeZone = TimeZoneInfo.FindSystemTimeZoneById(TimeZoneId)
        };
    }

    private IEnumerable<string> ValidateProperty(string propertyName, object? value)
    {
        var tempDto = new UpdateDestinationDto();
        var property = typeof(UpdateDestinationDto).GetProperty(propertyName);
        property?.SetValue(tempDto, value);
        var validationContext = new ValidationContext(tempDto) { MemberName = propertyName };
        var validationResults = new List<ValidationResult>();
        var propertyValue = property?.GetValue(tempDto);
        var attributes = property?.GetCustomAttributes(typeof(ValidationAttribute), true).Cast<ValidationAttribute>();
        if (attributes != null)
        {
            foreach (var attribute in attributes)
            {
                var result = attribute.GetValidationResult(propertyValue, validationContext);
                if (result != ValidationResult.Success && result != null)
                    validationResults.Add(result);
            }
        }
        return validationResults.Select(r => r.ErrorMessage ?? string.Empty);
    }

    private IEnumerable<string> ValidateCreateModel(object model)
    {
        var validationContext = new ValidationContext(model);
        var validationResults = new List<ValidationResult>();
        Validator.TryValidateObject(model, validationContext, validationResults, true);
        return validationResults.Select(r => r.ErrorMessage ?? string.Empty);
    }

    private async Task<GridData<DestinationEditModel>> ServerReload(GridState<DestinationEditModel> state)
    {
        var searchRequest = new DestinationSearchRequestDto
        {
            PaginationOptions = new PaginationOptions
            {
                PageNumber = state.Page + 1,
                PageSize = state.PageSize
            },
            OrderingOptions = null
        };
        foreach (var filterDefinition in state.FilterDefinitions)
        {
            var columnTitle = filterDefinition.Title ?? filterDefinition.Column?.PropertyName ?? string.Empty;
            var filterValue = filterDefinition.Value?.ToString();
            if (string.IsNullOrWhiteSpace(filterValue)) continue;
            switch (columnTitle?.ToLower())
            {
                case "name":
                case "nombre": searchRequest.Name = filterValue; break;
                case "code":
                case "código": searchRequest.Code = filterValue; break;
                case "city":
                case "ciudad": searchRequest.City = filterValue; break;
                case "region":
                case "región": searchRequest.Region = filterValue; break;
                case "country":
                case "país": searchRequest.Country = filterValue; break;
            }
        }
        if (state.SortDefinitions.Any())
        {
            var primarySort = state.SortDefinitions.First();
            var propertyName = primarySort.SortBy?.ToLower() ?? string.Empty;
            DestinationOrderBy orderBy = propertyName switch
            {
                "destinationid" => DestinationOrderBy.DestinationId,
                "name" => DestinationOrderBy.Name,
                "code" => DestinationOrderBy.Code,
                "city" => DestinationOrderBy.City,
                "region" => DestinationOrderBy.Region,
                "country" => DestinationOrderBy.Country,
                _ => DestinationOrderBy.DestinationId
            };
            searchRequest.OrderingOptions = new OrderingOptionsDto<DestinationOrderBy>
            {
                OrderBy = orderBy,
                Ascending = !primarySort.Descending
            };
        }
        try
        {
            var result = await DestinationService.SearchDestinationsAsync(searchRequest);
            return new GridData<DestinationEditModel>
            {
                Items = result.Items.Select(DestinationEditModel.FromDestination),
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar destinos: {ex.Message}", Severity.Error);
            return new GridData<DestinationEditModel> { Items = [], TotalItems = 0 };
        }
    }

    private async Task HandleCommittedItemChanges(DestinationEditModel item)
    {
        var updateDto = item.ToUpdateDto();
        var updateValidationContext = new ValidationContext(updateDto);
        var updateValidationResults = new List<ValidationResult>();
        if (!Validator.TryValidateObject(updateDto, updateValidationContext, updateValidationResults, true))
        {
            var errors = string.Join(", ", updateValidationResults.Select(r => r.ErrorMessage));
            Snackbar.Add($"Errores de validación: {errors}", Severity.Error);
            return;
        }
        try
        {
            await DestinationService.UpdateDestinationAsync(updateDto);
            Snackbar.Add("Destino actualizado correctamente", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al actualizar destino: {ex.Message}", Severity.Error);
            await dataGrid.ReloadServerData();
        }
    }

    private void HandleCanceledEditingItem(DestinationEditModel item) => _ = dataGrid.ReloadServerData();

    private async Task HandleCreateDestination()
    {
        await createForm.Validate();
        if (!createForm.IsValid)
        {
            Snackbar.Add("Por favor, corrija los errores del formulario", Severity.Warning);
            return;
        }
        try
        {
            await DestinationService.AddDestinationAsync(createModel);
            Snackbar.Add("Destino creado correctamente", Severity.Success);
            ClearCreateForm();
            await dataGrid.ReloadServerData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al crear destino: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleDeleteDestination(DestinationEditModel item)
    {
        try
        {
            await DestinationService.DeleteDestinationAsync(item.DestinationId);
            Snackbar.Add("Destino eliminado correctamente", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar destino: {ex.Message}", Severity.Error);
        }
    }

    private void ClearCreateForm()
    {
        createModel = new CreateDestinationDto();
        createForm?.ResetValidation();
    }
}