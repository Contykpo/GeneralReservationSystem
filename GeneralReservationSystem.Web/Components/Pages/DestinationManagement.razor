@page "/Admin/Destinations"

@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Services.Interfaces
@using GeneralReservationSystem.Application.Repositories.Interfaces
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Web.Components.Pages
@using GeneralReservationSystem.Web.Components.Shared

@inject IDestinationService DestinationService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<MudDialogProvider />

<PageTitle>Gestión de Destinos</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mx-auto">
    <MudContainer MaxWidth="MaxWidth.Large" Class="pt-4">
        <MudText Typo="Typo.h5">Gestión de Destinos</MudText>
        <MudDivider Class="mb-4" />
        @if (!string.IsNullOrWhiteSpace(lastErrorMessage))
        {
            <MudAlert Severity="MudBlazor.Severity.Error" Elevation="2" Class="mb-4">@lastErrorMessage</MudAlert>
        }

        <!-- Add Destination Form -->
        <MudExpansionPanels Class="my-4">
            <MudExpansionPanel Text="Agregar Destino">
                <EditForm Model="newDestination" OnValidSubmit="AddDestinationAsync" Class="p-2">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="newDestination.Name" Label="Nombre" Required="true" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="newDestination.Code" Label="Código" Required="true" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <DestinationLocationSelector
                                @bind-Country="newDestination.Country"
                                @bind-Region="newDestination.Region"
                                @bind-City="newDestination.City"
                                @bind-TimeZone="newDestination.TimeZone" />
                        </MudItem>
                        <MudItem xs="12">
                            <div class="d-flex justify-end">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Agregar</MudButton>
                            </div>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudExpansionPanel>
        </MudExpansionPanels>

        <!-- Search Section -->
        <MudPaper Elevation="1" Class="mb-1 p-2">
            <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                <MudTextField @bind-Value="searchName" Label="Buscar Nombre" Immediate="true" Variant="Variant.Outlined" Dense="true" Class="flex-auto d-inline-flex" />
                <MudTextField @bind-Value="searchCode" Label="Buscar Código" Immediate="true" Variant="Variant.Outlined" Dense="true" Class="flex-auto d-inline-flex" />
                <MudTextField @bind-Value="searchCity" Label="Buscar Ciudad" Immediate="true" Variant="Variant.Outlined" Dense="true" Class="flex-auto d-inline-flex" />
                <MudTextField @bind-Value="searchRegion" Label="Buscar Región" Immediate="true" Variant="Variant.Outlined" Dense="true" Class="flex-auto d-inline-flex" />
                <MudTextField @bind-Value="searchCountry" Label="Buscar País" Immediate="true" Variant="Variant.Outlined" Dense="true" Class="flex-auto d-inline-flex" />
            </MudStack>
        </MudPaper>

        <MudDivider Class="mb-4" />

        <!-- Destinations Table -->
        <MudTable Items="pagedDestinations?.Items ?? new List<Destination>()" Hover="true" Bordered="true" Dense="true" @bind-SortLabel="sortLabel" @bind-SortDirection="sortDirection" OnSort="OnSortChanged" Class="mb-4">
            <HeaderContent>
                <MudTh><MudTableSortLabel T="Destination" SortBy="x => x.Name">Nombre</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="Destination" SortBy="x => x.Code">Código</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="Destination" SortBy="x => x.City">Ciudad</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="Destination" SortBy="x => x.Region">Región</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel T="Destination" SortBy="x => x.Country">País</MudTableSortLabel></MudTh>
                <MudTh Style="width:1%; white-space:nowrap;">Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nombre">@context.Name</MudTd>
                <MudTd DataLabel="Código">@context.Code</MudTd>
                <MudTd DataLabel="Ciudad">@context.City</MudTd>
                <MudTd DataLabel="Región">@context.Region</MudTd>
                <MudTd DataLabel="País">@context.Country</MudTd>
                <MudTd Style="width:1%; white-space:nowrap;">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => EditDestination(context.DestinationId))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ConfirmDelete(context.DestinationId)" />
                </MudTd>
            </RowTemplate>
        </MudTable>

        <!-- Pagination Controls -->
        <MudGrid Class="mb-2">
            <MudItem xs="12" sm="4" md="3">
                <MudText Typo="Typo.body2">Total: <b>@(pagedDestinations?.TotalCount ?? 0)</b></MudText>
            </MudItem>
            <MudItem xs="12" sm="4" md="6">
                <div class="d-flex justify-center align-center" style="gap:8px; flex-wrap:wrap;">
                    <MudButton Variant="Variant.Outlined" Disabled="pageIndex == 0" OnClick="PrevPage">Anterior</MudButton>
                    @if (pagedDestinations != null)
                    {
                        for (int i = 0; i < pagedDestinations.TotalPages; i++)
                        {
                            var pageNum = i + 1;
                            var pageIndexCopy = i; // Fix: capture value for lambda
                            <MudButton Variant="Variant.Text" Color="@(i == pageIndex ? Color.Primary : Color.Default)" OnClick="() => GoToPage(pageIndexCopy)">@pageNum</MudButton>
                        }
                    }
                    <MudButton Variant="Variant.Outlined" Disabled="pagedDestinations == null || pageIndex >= pagedDestinations.TotalPages - 1" OnClick="NextPage">Siguiente</MudButton>
                </div>
            </MudItem>
            <MudItem xs="12" sm="4" md="3">
                <MudSelect T="int" @bind-Value="pageSize" Label="Tamaño de página" Dense="true" Style="width:120px">
                    <MudSelectItem Value="5">5</MudSelectItem>
                    <MudSelectItem Value="10">10</MudSelectItem>
                    <MudSelectItem Value="20">20</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudContainer>

@code {
    [Parameter, SupplyParameterFromQuery]
    public string searchName
    {
        get => _searchName;
        set
        {
            if (_searchName != value)
            {
                _searchName = value;
                pageIndex = 0;
                UpdateUrl();
                DebounceReload();
            }
        }
    }
    private string _searchName = "";
    [Parameter, SupplyParameterFromQuery]
    public string searchCode
    {
        get => _searchCode;
        set
        {
            if (_searchCode != value)
            {
                _searchCode = value;
                pageIndex = 0;
                UpdateUrl();
                DebounceReload();
            }
        }
    }
    private string _searchCode = "";
    [Parameter, SupplyParameterFromQuery]
    public string searchCity
    {
        get => _searchCity;
        set
        {
            if (_searchCity != value)
            {
                _searchCity = value;
                pageIndex = 0;
                UpdateUrl();
                DebounceReload();
            }
        }
    }
    private string _searchCity = "";
    [Parameter, SupplyParameterFromQuery]
    public string searchRegion
    {
        get => _searchRegion;
        set
        {
            if (_searchRegion != value)
            {
                _searchRegion = value;
                pageIndex = 0;
                UpdateUrl();
                DebounceReload();
            }
        }
    }
    private string _searchRegion = "";
    [Parameter, SupplyParameterFromQuery]
    public string searchCountry
    {
        get => _searchCountry;
        set
        {
            if (_searchCountry != value)
            {
                _searchCountry = value;
                pageIndex = 0;
                UpdateUrl();
                DebounceReload();
            }
        }
    }
    private string _searchCountry = "";
    [Parameter, SupplyParameterFromQuery]
    public int pageIndex
    {
        get => _pageIndex;
        set
        {
            int newIndex = value < 0 ? 0 : value;
            if (_pageIndex != newIndex)
            {
                _pageIndex = newIndex;
                UpdateUrl();
                _ = ReloadAsync();
            }
        }
    }
    private int _pageIndex = 0;
    [Parameter, SupplyParameterFromQuery]
    public int pageSize
    {
        get => _pageSize;
        set
        {
            int newSize = value <= 0 ? 10 : value;
            if (_pageSize != newSize)
            {
                _pageSize = newSize;
                pageIndex = 0;
                UpdateUrl();
                _ = ReloadAsync();
            }
        }
    }
    private int _pageSize = 10;
    string sortLabel = "";
    MudBlazor.SortDirection sortDirection = MudBlazor.SortDirection.None;

    PagedResult<Destination>? pagedDestinations;

    // Add Destination
    MudForm addForm;
    CreateDestinationDto newDestination = new() { TimeZone = TimeZoneInfo.Utc };
    bool isAddValid = true;

    // Delete
    int deleteId;

    // Debounce timer
    System.Timers.Timer? debounceTimer;
    const int DebounceDelay = 400;

    private string? lastErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    void UpdateUrl()
    {
        var uri = NavigationManager.GetUriWithQueryParameters(new Dictionary<string, object?>
        {
            [nameof(pageIndex)] = pageIndex,
            [nameof(pageSize)] = pageSize,
            [nameof(searchName)] = string.IsNullOrWhiteSpace(searchName) ? null : searchName,
            [nameof(searchCode)] = string.IsNullOrWhiteSpace(searchCode) ? null : searchCode,
            [nameof(searchCity)] = string.IsNullOrWhiteSpace(searchCity) ? null : searchCity,
            [nameof(searchRegion)] = string.IsNullOrWhiteSpace(searchRegion) ? null : searchRegion,
            [nameof(searchCountry)] = string.IsNullOrWhiteSpace(searchCountry) ? null : searchCountry
        });
        NavigationManager.NavigateTo(uri, replace: true);
    }

    async Task ReloadAsync()
    {
        lastErrorMessage = null;
        var sortBy = sortLabel switch
        {
            nameof(Destination.Name) => DestinationSearchSortBy.Name,
            nameof(Destination.Code) => DestinationSearchSortBy.Code,
            nameof(Destination.City) => DestinationSearchSortBy.City,
            nameof(Destination.Region) => DestinationSearchSortBy.Region,
            nameof(Destination.Country) => DestinationSearchSortBy.Country,
            _ => (DestinationSearchSortBy?)null
        };
        var result = await DestinationService.SearchDestinationsAsync(pageIndex, pageSize, searchName, searchCode, searchCity, searchRegion, searchCountry, sortBy, sortDirection == MudBlazor.SortDirection.Descending);
        bool clamped = false;
        result.IfValue(paged =>
        {
            pagedDestinations = paged;
            if (paged.TotalPages == 0)
            {
                if (pageIndex != 0) { pageIndex = 0; clamped = true; }
            }
            else if (pageIndex >= paged.TotalPages)
            {
                pageIndex = paged.TotalPages - 1;
                clamped = true;
            }
            pageIndex = paged.PageNumber;
        })
        .IfError(error => {
            lastErrorMessage = error ?? "Error al cargar destinos";
            Snackbar.Add(lastErrorMessage, MudBlazor.Severity.Error);
        });
        StateHasChanged();
        if (clamped)
        {
            UpdateUrl();
            await ReloadAsync();
        }
    }

    void PrevPage()
    {
        if (pageIndex > 0)
        {
            pageIndex = pageIndex - 1;
        }
    }

    void NextPage()
    {
        if (pagedDestinations != null && pageIndex < pagedDestinations.TotalPages - 1)
        {
            pageIndex = pageIndex + 1;
        }
    }

    void GoToPage(int idx)
    {
        if (pagedDestinations != null && idx >= 0 && idx < pagedDestinations.TotalPages)
        {
            pageIndex = idx;
        }
    }

    void OnSortChanged(string label, MudBlazor.SortDirection direction)
    {
        sortLabel = label;
        sortDirection = direction;
        pageIndex = 0;
        UpdateUrl();
        DebounceReload();
    }

    void OnPageSizeChanged(int newSize)
    {
        pageSize = newSize;
    }

    void DebounceReload()
    {
        debounceTimer?.Stop();
        debounceTimer?.Dispose();
        debounceTimer = new System.Timers.Timer(DebounceDelay);
        debounceTimer.Elapsed += async (_, __) =>
        {
            debounceTimer?.Stop();
            debounceTimer?.Dispose();
            debounceTimer = null;
            await InvokeAsync(ReloadAsync);
        };
        debounceTimer.AutoReset = false;
        debounceTimer.Start();
    }

    async Task AddDestinationAsync()
    {
        lastErrorMessage = null;
        var result = await DestinationService.AddDestinationAsync(newDestination);
        result.IfSuccess(() =>
        {
            Snackbar.Add("Destino agregado", MudBlazor.Severity.Success);
            newDestination = new() { TimeZone = TimeZoneInfo.Utc };
            _ = ReloadAsync();
        })
        .IfFailure(error => {
            lastErrorMessage = error ?? "No se pudo agregar el destino";
            Snackbar.Add(lastErrorMessage, MudBlazor.Severity.Error);
            StateHasChanged();
        });
    }

    async Task ConfirmDelete(int id)
    {
        deleteId = id;
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Confirmar eliminación", options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await DeleteDestinationAsync();
        }
    }

    async Task DeleteDestinationAsync()
    {
        lastErrorMessage = null;
        var result = await DestinationService.DeleteDestinationAsync(deleteId);
        result.IfSuccess(() =>
        {
            Snackbar.Add("Destino eliminado", MudBlazor.Severity.Success);
            _ = ReloadAsync();
        })
        .IfFailure(error => {
            lastErrorMessage = error ?? "No se pudo eliminar el destino";
            Snackbar.Add(lastErrorMessage, MudBlazor.Severity.Error);
            StateHasChanged();
        });
    }

    // Edit dialog
    private async Task EditDestination(int id)
    {
        lastErrorMessage = null;
        // Get destination by id
        var result = await DestinationService.GetDestinationByIdAsync(id);
        result.Match(
            onValue: async dest =>
            {
                var dto = new UpdateDestinationDto
                {
                    Id = dest.DestinationId,
                    Name = dest.Name,
                    Code = dest.Code,
                    City = dest.City,
                    Region = dest.Region,
                    Country = dest.Country,
                    TimeZone = dest.TimeZone
                };
                var parameters = new DialogParameters { ["editDestination"] = dto };
                var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
                var dialog = await DialogService.ShowAsync<DestinationEditDialog>("Editar Destino", parameters, options);
                var dialogResult = await dialog.Result;
                if (dialogResult != null && !dialogResult.Canceled)
                {
                    await ReloadAsync();
                }
            },
            onEmpty: () => Snackbar.Add("Destino no encontrado", MudBlazor.Severity.Error),
            onError: error => Snackbar.Add(error ?? "Error al cargar destino", MudBlazor.Severity.Error)
        );
    }

    private async Task OnCountryChanged(string value)
    {
        newDestination.Country = value;
        newDestination.Region = string.Empty;
        newDestination.City = string.Empty;
        await InvokeAsync(StateHasChanged);
    }
    private async Task OnRegionChanged(string value)
    {
        newDestination.Region = value;
        newDestination.City = string.Empty;
        await InvokeAsync(StateHasChanged);
    }
}
