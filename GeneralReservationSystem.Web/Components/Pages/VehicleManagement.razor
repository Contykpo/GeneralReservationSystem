@page "/Admin/Vehicles"

@using GeneralReservationSystem.Application.Repositories.Interfaces
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.DTOs

@inject IVehicleRepository VehicleRepository
@inject IVehicleModelRepository VehicleModelRepository
@inject ISeatRepository SeatRepository

@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudPaper Class="pa-4">

        <MudText Typo="Typo.h4" Class="mb-4">Vehicle Management</MudText>

        <!-- Search bar -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="searchLicensePlate" Label="Search by License Plate" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect @bind-Value="selectedStatus" Label="Status" Variant="Variant.Outlined" Clearable="true">
                    @foreach (var status in new List<string> { "Active", "Inactive", "Maintenance" })
                    {
                        <MudSelectItem T="string" Value="@status">@status</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="12" md="4" Class="d-flex align-center">
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="LoadVehicles">Search</MudButton>
                <MudButton Color="Color.Secondary" Variant="Variant.Outlined" Class="ml-2" OnClick="ResetFilters">Reset</MudButton>
            </MudItem>
        </MudGrid>

        <!-- Vehicle Data table -->
        <MudTable Items="@vehicles" Dense="true" Hover="true" Bordered="true">
            <HeaderContent>
                <MudTh>Model</MudTh>
                <MudTh>Manufacturer</MudTh>
                <MudTh>License Plate</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Model">@context.ModelName</MudTd>
                <MudTd DataLabel="Manufacturer">@context.Manufacturer</MudTd>
                <MudTd DataLabel="License Plate">@context.LicensePlate</MudTd>
                <MudTd DataLabel="Status">@context.Status</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="() => EditVehicle(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteVehicle(context.VehicleId)" />
                </MudTd>
            </RowTemplate>
        </MudTable>

        <MudDivider Class="my-4" />

        <!-- Vehicle Form dialog -->
        <MudDialog @bind-IsVisible="isDialogOpen" MaxWidth="MaxWidth.Medium">
            <DialogContent>
                <MudText Typo="Typo.h6">@dialogTitle</MudText>

                <MudForm @ref="form">
                    <MudSelect T="int" @bind-Value="currentVehicle.VehicleModelId" Label="Vehicle Model" Required="true">
                        @foreach (var model in vehicleModels)
                        {
                            <MudSelectItem Value="@model.VehicleModelId">@($"{model.Name} ({model.Manufacturer})")</MudSelectItem>
                        }
                    </MudSelect>

                    <MudTextField @bind-Value="currentVehicle.LicensePlate" Label="License Plate" Required="true" />

                    <MudSelect @bind-Value="currentVehicle.Status" Label="Status" Required="true">
                        @foreach (var status in new List<string> { "Active", "Inactive", "Maintenance" })
                        {
                            <MudSelectItem T="string" Value="@status">@status</MudSelectItem>
                        }
                    </MudSelect>

                    <MudButton Color="Color.Secondary" Variant="Variant.Text" Class="mt-2" OnClick="OpenSeatDialog">Manage Seats</MudButton>
                </MudForm>
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="SaveVehicle" Color="Color.Primary">Save</MudButton>
                <MudButton OnClick="() => isDialogOpen = false" Color="Color.Secondary">Cancel</MudButton>
            </DialogActions>
        </MudDialog>

        <!-- Seat Management Dialog -->
        <MudDialog @bind-IsVisible="isSeatDialogOpen" MaxWidth="MaxWidth.Large">
            <DialogContent>
                <MudText Typo="Typo.h6">Manage Seats for Model: @selectedModel?.Name</MudText>

                <MudTable Items="@seats" Dense="true" Hover="true" Bordered="true" Class="mt-3">
                    <HeaderContent>
                        <MudTh>Row</MudTh>
                        <MudTh>Column</MudTh>
                        <MudTh>Window</MudTh>
                        <MudTh>Aisle</MudTh>
                        <MudTh>Front</MudTh>
                        <MudTh>Back</MudTh>
                        <MudTh>Accessible</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.SeatRow</MudTd>
                        <MudTd>@context.SeatColumn</MudTd>
                        <MudTd><MudCheckBox T="bool" @bind-Checked="context.IsAtWindow" Disabled="true" /></MudTd>
                        <MudTd><MudCheckBox T="bool" @bind-Checked="context.IsAtAisle" Disabled="true" /></MudTd>
                        <MudTd><MudCheckBox T="bool" @bind-Checked="context.IsInFront" Disabled="true" /></MudTd>
                        <MudTd><MudCheckBox T="bool" @bind-Checked="context.IsInBack" Disabled="true" /></MudTd>
                        <MudTd><MudCheckBox T="bool" @bind-Checked="context.IsAccessible" Disabled="true" /></MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="() => EditSeat(context)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteSeat(context.SeatId)" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <MudDivider Class="my-2" />

                <!-- Add/Edit Seat Form -->
                <MudForm @ref="seatForm">
                    <MudGrid>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="currentSeat.SeatRow" Label="Row" Required="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="currentSeat.SeatColumn" Label="Column" Required="true" />
                        </MudItem>
                    </MudGrid>

                    <MudCheckBox T="bool" @bind-Checked="currentSeat.IsAtWindow" Label="Window" />
                    <MudCheckBox T="bool" @bind-Checked="currentSeat.IsAtAisle" Label="Aisle" />
                    <MudCheckBox T="bool" @bind-Checked="currentSeat.IsInFront" Label="Front" />
                    <MudCheckBox T="bool" @bind-Checked="currentSeat.IsInBack" Label="Back" />
                    <MudCheckBox T="bool" @bind-Checked="currentSeat.IsAccessible" Label="Accessible" />
                </MudForm>
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="SaveSeat" Color="Color.Primary">Save Seat</MudButton>
                <MudButton OnClick="() => isSeatDialogOpen = false" Color="Color.Secondary">Close</MudButton>
            </DialogActions>
        </MudDialog>

        <!-- Add Vehicle button -->
        <MudFab Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Class="mud-fab-bottom-right" OnClick="AddVehicle" />
    </MudPaper>
</MudContainer>

@code
{
    private bool isDialogOpen = false;
    private bool isSeatDialogOpen = false;
    private string dialogTitle = "Add Vehicle";

    private MudForm form;
    private MudForm seatForm;

    private Seat currentSeat = new();
    private Vehicle currentVehicle = new();
    private VehicleModel selectedModel = new();

    private List<VehicleDetailsDto> vehicles = new();
    private List<VehicleModel> vehicleModels = new();
    private List<Seat> seats = new();

    private string searchLicensePlate = string.Empty;
    private string selectedStatus = string.Empty;


    protected override async Task OnInitializedAsync()
    {
        await LoadVehicles();
        await LoadVehicleModels();
    }

    private async Task LoadVehicles()
    {
        var result = await VehicleRepository.SearchPagedAsync(0, 20, licensePlate: searchLicensePlate, sortBy: VehicleSearchSortBy.LicensePlate);
        result.IfValue(r => vehicles = r.Items.ToList())
              .IfError(err => Snackbar.Add(err, MudBlazor.Severity.Error));
    }

    private async Task LoadVehicleModels()
    {
        var result = await VehicleModelRepository.SearchPagedAsync(0, 50);
        result.IfValue(r => vehicleModels = r.Items.ToList())
              .IfError(error => Snackbar.Add(error, MudBlazor.Severity.Error));
    }

    private void ResetFilters()
    {
        searchLicensePlate = string.Empty;
        selectedStatus = null;
        _ = LoadVehicles();
    }

    private void AddVehicle()
    {
        currentVehicle = new Vehicle();
        dialogTitle = "Add Vehicle";
        isDialogOpen = true;
    }

    private void EditVehicle(VehicleDetailsDto dto)
    {
        currentVehicle = new Vehicle
        {
            VehicleId = dto.VehicleId,
            VehicleModelId = dto.VehicleModelId,
            LicensePlate = dto.LicensePlate,
            Status = dto.Status
        };
        dialogTitle = "Edit Vehicle";
        isDialogOpen = true;
    }

    private async Task SaveVehicle()
    {
        await form.Validate();
        if (!form.IsValid) return;

        OperationResult result;
        if (currentVehicle.VehicleId == 0)
            result = await VehicleRepository.AddAsync(currentVehicle);
        else
            result = await VehicleRepository.UpdateAsync(currentVehicle);

        result.IfSuccess(() =>
        {
            Snackbar.Add("Vehicle saved successfully", MudBlazor.Severity.Success);
            isDialogOpen = false;
            _ = LoadVehicles();
        })
        .IfFailure(err => Snackbar.Add(err ?? "Error saving vehicle", MudBlazor.Severity.Error));
    }

    private async Task DeleteVehicle(int id)
    {
        var result = await VehicleRepository.DeleteAsync(id);
        result.IfSuccess(() =>
        {
            Snackbar.Add("Vehicle deleted successfully", MudBlazor.Severity.Success);
            _ = LoadVehicles();
        })
        .IfFailure(err => Snackbar.Add(err ?? "Error deleting vehicle", MudBlazor.Severity.Error));
    }

    private async void OpenSeatDialog()
    {
        selectedModel = vehicleModels.FirstOrDefault(m => m.VehicleModelId == currentVehicle.VehicleModelId)!;
        
        if (selectedModel == null)
        {
            Snackbar.Add("Please select a vehicle model first", MudBlazor.Severity.Warning);
            return;
        }

        // Ideally, you'd have a SeatRepository.SearchByModelIdAsync - for demo we’ll mock loading
        var seatResult = await SeatRepository.GetByIdAsync(0); // replace with your method for fetching multiple
        // Example only, you’d replace with real query
        seats = new List<Seat>(); 

        currentSeat = new Seat { VehicleModelId = selectedModel.VehicleModelId };
        isSeatDialogOpen = true;
    }

    private void EditSeat(Seat seat)
    {
        currentSeat = new Seat
        {
            SeatId = seat.SeatId,
            VehicleModelId = seat.VehicleModelId,
            SeatRow = seat.SeatRow,
            SeatColumn = seat.SeatColumn,
            IsAtWindow = seat.IsAtWindow,
            IsAtAisle = seat.IsAtAisle,
            IsInFront = seat.IsInFront,
            IsInBack = seat.IsInBack,
            IsAccessible = seat.IsAccessible
        };
    }

    private async Task SaveSeat()
    {
        await seatForm.Validate();
        if (!seatForm.IsValid) return;

        OperationResult result;
        if (currentSeat.SeatId == 0)
            result = await SeatRepository.AddAsync(currentSeat);
        else
            result = await SeatRepository.UpdateAsync(currentSeat);

        result.IfSuccess(() =>
        {
            Snackbar.Add("Seat saved successfully", MudBlazor.Severity.Success);
            _ = LoadSeatsForModel(currentSeat.VehicleModelId);
        })
        .IfFailure(err => Snackbar.Add(err ?? "Error saving seat", MudBlazor.Severity.Error));
    }

    private async Task DeleteSeat(int seatId)
    {
        var result = await SeatRepository.DeleteAsync(seatId);
        result.IfSuccess(() =>
        {
            Snackbar.Add("Seat deleted successfully", MudBlazor.Severity.Success);
            _ = LoadSeatsForModel(currentSeat.VehicleModelId);
        })
        .IfFailure(err => Snackbar.Add(err ?? "Error deleting seat", MudBlazor.Severity.Error));
    }

    private async Task LoadSeatsForModel(int modelId)
    {
        // TODO: We might want to implement a GetByModelIdAsync method in ISeatRepository.
        seats = new List<Seat>();
    }
}
