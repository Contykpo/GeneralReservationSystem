@page "/admin/users"

@attribute [Authorize(Roles = AdminRoleName)]

@using FluentValidation
@using GeneralReservationSystem.Web.Client.Authentication
@using GeneralReservationSystem.Web.Client.Helpers
@using GeneralReservationSystem.Web.Client.Exceptions
@using GeneralReservationSystem.Web.Client.Services.Interfaces.Authentication
@using GeneralReservationSystem.Web.Client.Components.DeleteDialog
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.DTOs.Authentication
@using GeneralReservationSystem.Application.Entities.Authentication
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces.Authentication
@using GeneralReservationSystem.Application.Validators.Authentication
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@using AppFilterOperator = GeneralReservationSystem.Application.Common.FilterOperator
@using Severity = MudBlazor.Severity

@inject IClientAuthenticationService ClientAuthenticationService
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserService UserService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Gestión de Usuarios</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <MudCard>

        <MudCardHeader>

            <CardHeaderContent>
                <MudText Typo="Typo.h6">Usuarios</MudText>
            </CardHeaderContent>

            <CardHeaderActions>

                <MudButton 
                    Variant     ="Variant.Filled" 
                    Color       ="Color.Primary" 
                    StartIcon   ="@Icons.Material.Filled.Add" 
                    Href        ="/admin/create-admin"> Agregar Administrador </MudButton>


                <MudButton 
                    Variant     ="Variant.Filled" 
                    Color       ="Color.Primary" 
                    OnClick     ="@(() => _table!.ReloadServerData())" 
                    StartIcon   ="@Icons.Material.Filled.Refresh">Actualizar</MudButton>

            </CardHeaderActions>

        </MudCardHeader>

        @*Filtros de busqueda*@
        <MudCardContent>
            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel Text="Filtros avanzados" Icon="@Icons.Material.Filled.FilterList">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudTextField @bind-Value="_filterUserName" 
                                          Label="Nombre de Usuario" 
                                          Variant="Variant.Outlined"
                                          Clearable="true"
                                          OnClearButtonClick="@(() => { _filterUserName = string.Empty; _table!.ReloadServerData(); })"
                                          Immediate="true"
                                          DebounceInterval="300"
                                          OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudTextField @bind-Value="_filterEmail" 
                                          Label="Correo Electrónico" 
                                          Variant="Variant.Outlined"
                                          Clearable="true"
                                          OnClearButtonClick="@(() => { _filterEmail = string.Empty; _table!.ReloadServerData(); })"
                                          Immediate="true"
                                          DebounceInterval="300"
                                          OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">Limpiar Filtros</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>

            @*Tabla de usuarios*@
            <MudTable @ref="_table" 
                      T="UserInfo" 
                      ServerData="ServerReload"
                      Loading="@_loading" 
                      LoadingProgressColor="Color.Primary"
                      Hover="true" 
                      Breakpoint="Breakpoint.Sm"
                      Dense="true"
                      RowsPerPage="10"
                      SortLabel="UserId"
                      Elevation="0">

                @*Buscador general*@
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString" 
                                  Placeholder="Buscar en todos los campos - omite filtros avanzados" 
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" 
                                  Class="mt-0"
                                  Clearable="true"
                                  OnClearButtonClick="@(() => { _searchString = string.Empty; _table!.ReloadServerData(); })"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())"></MudTextField>
                </ToolBarContent>

                @*Headers tabla*@
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortLabel="UserId"    T="UserInfo">ID</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="UserName"  T="UserInfo">Usuario</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="Email"     T="UserInfo">Correo</MudTableSortLabel></MudTh>
                    <MudTh>Admin</MudTh>
                    <MudTh Style="text-align: right">Acciones</MudTh>
                </HeaderContent>

                @*Plantilla de los elementos*@
                <RowTemplate>
                    <MudTd DataLabel="ID">      @context.UserId     </MudTd>
                    <MudTd DataLabel="Usuario"> @context.UserName   </MudTd>
                    <MudTd DataLabel="Correo">  @context.Email      </MudTd>

                    <MudTd DataLabel="Admin">
                        @if (context.IsAdmin)
                        {
                            <MudText>Si</MudText>
                        }
                        else
                        {
                            <MudText>No</MudText>
                        }
                    </MudTd>

                    <MudTd DataLabel="Acciones" Style="text-align: right">
                        @if (context.UserId != _user.UserId)
                        {
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditDialog(context))" />
                            <DeleteButton TItem="UserInfo" Value="@context" OnDeleteConfirmed="HandleDelete"></DeleteButton>
                        }
                        else
                        {
                            <MudText Color="Color.Success">Sos vos!</MudText>
                        }
                    </MudTd>

                </RowTemplate>

                <NoRecordsContent>
                    <MudText>No se encontraron usuarios.</MudText>
                </NoRecordsContent>

                <LoadingContent>
                    <MudText>Cargando...</MudText>
                </LoadingContent>

                <PagerContent>
                    <MudTablePager 
                        RowsPerPageString="Filas por pagina"
                        PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>

            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@*Dialogo de edicion de usuario*@
<MudDialog @bind-Visible="_editDialogVisible" Options="_editDialogOptions">

    <TitleContent>

        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3" /> Editar Usuario
        </MudText>

    </TitleContent>

    <DialogContent>

        <MudForm Model="@_editUserDto" @ref="_updateForm" Validation="@(_updateUserDtoValidator.ValidateValue)" ValidationDelay="0">

            <MudTextField Label="Nombre de Usuario"
                          @bind-Value="_editUserDto.UserName" 
                          For="@(() => _editUserDto.UserName)"
                          Variant="Variant.Outlined" 
                          Margin="Margin.Dense"
                          Immediate="true" />

            <MudTextField Label="Correo Electrónico"
                          @bind-Value="_editUserDto.Email"
                          For="@(() => _editUserDto.Email)"
                          Variant="Variant.Outlined" 
                          Margin="Margin.Dense" 
                          Immediate="true" />
        </MudForm>

    </DialogContent>

    <DialogActions>

        <MudButton OnClick="CloseEditDialog" Variant="Variant.Outlined">Cancelar</MudButton>

        <MudButton OnClick="HandleUpdate" Variant="Variant.Filled" Color="Color.Primary">Guardar</MudButton>

    </DialogActions>

</MudDialog>

@code {
    private MudTable<UserInfo>  _table          = null!;
    private bool                _loading        = false;
    private string              _searchString   = string.Empty;

    // Advanced filters
    private string _filterUserName  = string.Empty;
    private string _filterEmail     = string.Empty;

    private MudForm _updateForm         = null!;
    private UpdateUserDto _editUserDto  = new();
    private UpdateUserDtoValidator _updateUserDtoValidator = new();

    private UserInfo _user = null!;

    private bool _editDialogVisible             = false;
    private DialogOptions _editDialogOptions    = new()
    {
        MaxWidth            = MaxWidth.Medium,
        FullWidth           = true,
        CloseButton         = true,
        Position            = DialogPosition.Center,
        CloseOnEscapeKey    = true
    };

    protected override async Task OnInitializedAsync()
    {
        _user = await ClientAuthenticationService.GetCurrentUserAsync();
    }

    private async Task<TableData<UserInfo>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var searchRequest = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize,
                FilterClauses = BuildFilterClauses(state),
                Orders = TableHelpers.BuildOrders(state)
            };

            var result = await UserService.SearchUsersAsync(searchRequest, cancellationToken);
            return new TableData<UserInfo>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error al cargar usuarios.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }

        return new TableData<UserInfo> { Items = [], TotalItems = 0 };
    }

    private IEnumerable<FilterClause> BuildFilterClauses(TableState state)
    {
        var filterClauses = new List<FilterClause>();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            var searchFilters = new List<Filter>
            {
                new Filter("UserName", AppFilterOperator.Contains, _searchString),
                new Filter("Email", AppFilterOperator.Contains, _searchString)
            };
            filterClauses.Add(new FilterClause(searchFilters));
        }
        else
        {
            if (!string.IsNullOrWhiteSpace(_filterUserName))
            {
                filterClauses.Add(new FilterClause([
                    new Filter("UserName", AppFilterOperator.Contains, _filterUserName)
                ]));
            }

            if (!string.IsNullOrWhiteSpace(_filterEmail))
            {
                filterClauses.Add(new FilterClause([
                    new Filter("Email", AppFilterOperator.Contains, _filterEmail)
                ]));
            }
        }

        return filterClauses;
    }

    private void ClearFilters()
    {
        _filterUserName = string.Empty;
        _filterEmail    = string.Empty;
        _searchString   = string.Empty;
        _table!.ReloadServerData();
    }

    private void OpenEditDialog(UserInfo user)
    {
        _editUserDto = new UpdateUserDto
        {
            UserId      = user.UserId,
            UserName    = user.UserName,
            Email       = user.Email
        };

        _updateForm?.ResetValidation();
        _editDialogVisible = true;
    }

    private void CloseEditDialog()
    {
        _editDialogVisible  = false;
        _editUserDto        = new UpdateUserDto();
        _updateForm?.ResetValidation();
    }

    private async Task HandleUpdate()
    {
        if (_editUserDto.UserId == _user.UserId)
        {
            Snackbar.Add("Para editar tu propio usuario dirigete a tu perfil.", Severity.Warning);

            return;
        }

        if (_updateForm is not null)
        {
            await _updateForm.Validate();
            if (!_updateForm.IsValid)
                return;
        }

        try
        {
            await UserService.UpdateUserAsync(_editUserDto);

            Snackbar.Add("Usuario actualizado correctamente.", Severity.Success);

            CloseEditDialog();

            await _table.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            CloseEditDialog();
            await _table.ReloadServerData();
        }
        catch (ServiceValidationException ex)
        {
            foreach (var error in ex.Errors)
            {
                Snackbar.Add(error.Error, Severity.Error);
            }
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error inesperado al actualizar el usuario.", Severity.Error);
        }
    }

    private async Task HandleDelete(UserInfo item)
    {
        if (_user.UserId == item.UserId)
        {
            Snackbar.Add("No puedes eliminar tu propio usuario desde aquí.", Severity.Warning);

            return;
        }

        try
        {
            await UserService.DeleteUserAsync(new UserKeyDto { UserId = item.UserId });

            Snackbar.Add("Usuario eliminado correctamente.", Severity.Success);

            await _table.ReloadServerData();
        }
        catch (Exception genericException)
        {
            switch (genericException)
            {
                case ServiceException ex:
                    Snackbar.Add(ex.Message, Severity.Error);
                    await _table.ReloadServerData();
                    break;

                default:
                    Snackbar.Add("Error inesperado al eliminar el usuario.", Severity.Error);
                    break;
            }
        }
    }
}
