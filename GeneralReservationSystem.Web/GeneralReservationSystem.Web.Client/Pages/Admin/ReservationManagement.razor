@page "/admin/reservations"

@attribute [Authorize(Roles = "Admin")]

@using GeneralReservationSystem.Web.Client.Helpers
@using GeneralReservationSystem.Web.Client.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces

@using AppFilterOperator = GeneralReservationSystem.Application.Common.FilterOperator
@using Severity = MudBlazor.Severity

@inject IClientReservationService ClientReservationService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <PageTitle>Gestión de Reservas</PageTitle>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Reservas</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => _table!.ReloadServerData())" StartIcon="@Icons.Material.Filled.Refresh">Actualizar</MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel Text="Filtros avanzados" Icon="@Icons.Material.Filled.FilterList">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="_filterTripId" 
                                             Label="ID de Viaje" 
                                             Variant="Variant.Outlined"
                                             Clearable="true"
                                             Immediate="true"
                                             DebounceInterval="300"
                                             OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="_filterUserId" 
                                             Label="ID de Usuario" 
                                             Variant="Variant.Outlined"
                                             Clearable="true"
                                             Immediate="true"
                                             DebounceInterval="300"
                                             OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="_filterSeat" 
                                             Label="Asiento" 
                                             Variant="Variant.Outlined"
                                             Clearable="true"
                                             Immediate="true"
                                             DebounceInterval="300"
                                             OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_filterDepartureStationName" Label="Estación Salida" Variant="Variant.Outlined" Clearable="true" Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_filterArrivalStationName" Label="Estación Llegada" Variant="Variant.Outlined" Clearable="true" Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_filterDepartureCity" Label="Ciudad Salida" Variant="Variant.Outlined" Clearable="true" Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_filterArrivalCity" Label="Ciudad Llegada" Variant="Variant.Outlined" Clearable="true" Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_filterUserName" Label="Usuario" Variant="Variant.Outlined" Clearable="true" Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_filterEmail" Label="Email" Variant="Variant.Outlined" Clearable="true" Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">Limpiar Filtros</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudTable @ref="_table" 
                      T="ReservationDetailsDto" 
                      ServerData="ServerReload"
                      Loading="@_loading" 
                      LoadingProgressColor="Color.Primary"
                      Hover="true" 
                      Breakpoint="Breakpoint.Sm"
                      Dense="true"
                      RowsPerPage="10"
                      SortLabel="TripId"
                      Elevation="0">
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString" 
                                  Placeholder="Buscar en todos los campos" 
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" 
                                  Class="mt-0"
                                  Clearable="true"
                                  OnClearButtonClick="@(() => { _searchString = string.Empty; _table!.ReloadServerData(); })"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  OnDebounceIntervalElapsed="@(() => _table!.ReloadServerData())"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortLabel="TripId" T="ReservationDetailsDto">ID Viaje</MudTableSortLabel></MudTh>
                    <MudTh>Salida</MudTh>
                    <MudTh>Llegada</MudTh>
                    <MudTh><MudTableSortLabel SortLabel="UserId" T="ReservationDetailsDto">Usuario</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="Seat" T="ReservationDetailsDto">Asiento</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: right">Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID Viaje">@context.TripId</MudTd>
                    <MudTd DataLabel="Salida">
                        <div>
                            <b>@context.DepartureStationName</b><br />
                            @context.DepartureCity, @context.DepartureProvince, @context.DepartureCountry<br />
                            <span>@context.DepartureTime.ToString("g")</span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Llegada">
                        <div>
                            <b>@context.ArrivalStationName</b><br />
                            @context.ArrivalCity, @context.ArrivalProvince, @context.ArrivalCountry<br />
                            <span>@context.ArrivalTime.ToString("g")</span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Usuario">
                        <div>
                            <b>@context.UserName</b><br />
                            <span>@context.Email</span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Asiento">@context.Seat</MudTd>
                    <MudTd DataLabel="Acciones" Style="text-align: right">
                        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDelete(context))" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No se encontraron reservas.</MudText>
                </NoRecordsContent>
                <LoadingContent>
                    <MudText>Cargando...</MudText>
                </LoadingContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private MudTable<ReservationDetailsDto> _table = null!;
    private bool _loading = false;
    private string _searchString = string.Empty;
    
    // Advanced filters
    private int? _filterTripId = null;
    private int? _filterUserId = null;
    private int? _filterSeat = null;
    private string? _filterDepartureStationName = null;
    private string? _filterArrivalStationName = null;
    private string? _filterDepartureCity = null;
    private string? _filterArrivalCity = null;
    private string? _filterUserName = null;
    private string? _filterEmail = null;

    private async Task<TableData<ReservationDetailsDto>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var searchRequest = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize,
                Filters = BuildFilters(state),
                Orders = TableHelpers.BuildOrders(state)
            };

            var result = await ClientReservationService.SearchReservationsAsync(searchRequest, cancellationToken);
            return new TableData<ReservationDetailsDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error al cargar reservas.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }

        return new TableData<ReservationDetailsDto> { Items = [], TotalItems = 0 };
    }

    private IList<Filter> BuildFilters(TableState state)
    {
        List<Filter> filters = [];

        // Global search filter
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            if (int.TryParse(_searchString, out var numericValue))
            {
                filters.Add(new Filter("TripId", AppFilterOperator.Equals, numericValue));
                filters.Add(new Filter("UserId", AppFilterOperator.Equals, numericValue));
                filters.Add(new Filter("Seat", AppFilterOperator.Equals, numericValue));
            }
            else
            {
                filters.Add(new Filter("DepartureStationName", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("ArrivalStationName", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("DepartureCity", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("ArrivalCity", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("UserName", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("Email", AppFilterOperator.Contains, _searchString));
            }
        }
        else
        {
            if (_filterTripId.HasValue)
                filters.Add(new Filter("TripId", AppFilterOperator.Equals, _filterTripId.Value));
            if (_filterUserId.HasValue)
                filters.Add(new Filter("UserId", AppFilterOperator.Equals, _filterUserId.Value));
            if (_filterSeat.HasValue)
                filters.Add(new Filter("Seat", AppFilterOperator.Equals, _filterSeat.Value));
            if (!string.IsNullOrWhiteSpace(_filterDepartureStationName))
                filters.Add(new Filter("DepartureStationName", AppFilterOperator.Contains, _filterDepartureStationName));
            if (!string.IsNullOrWhiteSpace(_filterArrivalStationName))
                filters.Add(new Filter("ArrivalStationName", AppFilterOperator.Contains, _filterArrivalStationName));
            if (!string.IsNullOrWhiteSpace(_filterDepartureCity))
                filters.Add(new Filter("DepartureCity", AppFilterOperator.Contains, _filterDepartureCity));
            if (!string.IsNullOrWhiteSpace(_filterArrivalCity))
                filters.Add(new Filter("ArrivalCity", AppFilterOperator.Contains, _filterArrivalCity));
            if (!string.IsNullOrWhiteSpace(_filterUserName))
                filters.Add(new Filter("UserName", AppFilterOperator.Contains, _filterUserName));
            if (!string.IsNullOrWhiteSpace(_filterEmail))
                filters.Add(new Filter("Email", AppFilterOperator.Contains, _filterEmail));
        }

        return filters;
    }

    private void ClearFilters()
    {
        _filterTripId = null;
        _filterUserId = null;
        _filterSeat = null;
        _filterDepartureStationName = null;
        _filterArrivalStationName = null;
        _filterDepartureCity = null;
        _filterArrivalCity = null;
        _filterUserName = null;
        _filterEmail = null;
        _searchString = string.Empty;
        _table!.ReloadServerData();
    }

    private async Task HandleDelete(ReservationDetailsDto item)
    {
        try
        {
            await ClientReservationService.DeleteReservationAsync(new ReservationKeyDto { TripId = item.TripId, Seat = item.Seat });
            Snackbar.Add("Reserva eliminada correctamente.", Severity.Success);
            await _table.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await _table.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error inesperado al eliminar la reserva.", Severity.Error);
        }
    }
}
