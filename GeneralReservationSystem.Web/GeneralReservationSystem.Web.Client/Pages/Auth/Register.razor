@page "/register"

@using GeneralReservationSystem.Application.DTOs.Authentication
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Web.Services.Authentication
@using GeneralReservationSystem.Web.Client.Services

@inject GeneralReservationSystem.Application.Services.Interfaces.Authentication.IUserService UserService
@inject NavigationManager Navigation
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<MudPaper Class="mx-auto my-5 p-4" Style="max-width:400px;" Color="Color.Surface" Elevation="6">
    <MudText Typo="Typo.h5" Class="mb-4">Register</MudText>
    <MudForm @ref="_form">
        <MudTextField Label="Nombre de usuario" For="@(() => _registerDto.UserName)" @bind-Value="_registerDto.UserName" Required="true" Class="mb-3" />
        <MudTextField Label="Correo electrónico" For="@(() => _registerDto.Email)" @bind-Value="_registerDto.Email" Required="true" Class="mb-3" />
        <MudTextField Label="Contraseña" For="@(() => _registerDto.Password)" @bind-Value="_registerDto.Password" InputType="InputType.Password" Required="true" Class="mb-3" />
        <MudTextField Label="Confirmación de contraseña" For="@(() => _registerDto.ConfirmPassword)" @bind-Value="_registerDto.ConfirmPassword" InputType="InputType.Password" Required="true" Class="mb-3" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="HandleRegister">Registrarse</MudButton>
        @if (!string.IsNullOrEmpty(_error))
        {
            <MudAlert Severity="MudBlazor.Severity.Error" Class="mt-3">@_error</MudAlert>
        }
    </MudForm>
</MudPaper>

@code {
    private RegisterUserDto _registerDto = new();
    private MudForm _form = null!;
    private string _error = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleRegister()
    {
        _error = string.Empty;
        await _form.Validate();
        if (!_form.IsValid)
            return;
        try
        {
            var user = await UserService.RegisterUserAsync(_registerDto);
            if (AuthStateProvider is CustomAuthenticationStateProvider custom)
            {
                custom.MarkUserAsAuthenticated(user);
            }
            Navigation.NavigateTo("/");
        }
        catch (ServiceBusinessException ex)
        {
            _error = ex.Message;
        }
    }
}
