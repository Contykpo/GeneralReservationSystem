@page "/reservations"

@attribute [Authorize]

@using GeneralReservationSystem.Web.Client.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces

@inject IClientReservationService ClientReservationService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <PageTitle>Mis Reservas</PageTitle>
    <MudDataGrid @ref="dataGrid"
                 T="UserReservationDetailsDto"
                 ServerData="ServerReload"
                 RowsPerPage="10">
        <Columns>
            <PropertyColumn Property="x => x.TripId" Title="Viaje" />
            <TemplateColumn Title="Salida">
                <CellTemplate>
                    <div>
                        <b>@context.Item.DepartureStationName</b><br />
                        @context.Item.DepartureCity, @context.Item.DepartureRegion, @context.Item.DepartureCountry<br />
                        <span>@context.Item.DepartureTime.ToString("g")</span>
                    </div>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Llegada">
                <CellTemplate>
                    <div>
                        <b>@context.Item.ArrivalStationName</b><br />
                        @context.Item.ArrivalCity, @context.Item.ArrivalRegion, @context.Item.ArrivalCountry<br />
                        <span>@context.Item.ArrivalTime.ToString("g")</span>
                    </div>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.Seat" Title="Asiento" />
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDelete(context.Item))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="UserReservationDetailsDto" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>

@code {
    private MudDataGrid<UserReservationDetailsDto> dataGrid = null!;

    private async Task<GridData<UserReservationDetailsDto>> ServerReload(GridState<UserReservationDetailsDto> state)
    {
        try
        {
            var list = await ClientReservationService.GetCurrentUserReservationsAsync();
            return new GridData<UserReservationDetailsDto> { Items = list, TotalItems = list.Count() };
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error al cargar reservas.", Severity.Error);
        }
        return new GridData<UserReservationDetailsDto> { Items = Array.Empty<UserReservationDetailsDto>(), TotalItems = 0 };
    }

    private async Task HandleDelete(UserReservationDetailsDto item)
    {
        try
        {
            await ClientReservationService.DeleteReservationAsync(new ReservationKeyDto { TripId = item.TripId, Seat = item.Seat });
            Snackbar.Add("Reserva eliminada.", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error inesperado.", Severity.Error);
        }
    }
}
