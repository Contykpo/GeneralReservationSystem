@page "/reservations"

@attribute [Authorize]

@using GeneralReservationSystem.Web.Client.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces

@using AppFilterOperator = GeneralReservationSystem.Application.Common.FilterOperator

@inject IClientReservationService ClientReservationService
@inject ISnackbar Snackbar
@inject IClientStationService StationService

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <PageTitle>Mis Reservas</PageTitle>
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Mis Reservas</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => dataGrid.ReloadServerData())" StartIcon="@Icons.Material.Filled.Refresh">Actualizar</MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel Text="Filtros avanzados" Icon="@Icons.Material.Filled.FilterList">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="int?" Label="Estación Salida"
                                      Value="_filterDepartureStationId"
                                      ValueChanged="@(async (int? value) => { _filterDepartureStationId = value; await OnFilterChanged(); })"
                                      Variant="Variant.Outlined"
                                      Clearable="true"
                                      Immediate="true">
                                <MudSelectItem T="int?" Value="null">Todas</MudSelectItem>
                                @foreach (var station in _stations)
                                {
                                    <MudSelectItem T="int?" Value="@station.StationId">
                                        @station.StationName, @station.City, @station.Province, @station.Country
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="int?" Label="Estación Llegada"
                                      Value="_filterArrivalStationId"
                                      ValueChanged="@(async (int? value) => { _filterArrivalStationId = value; await OnFilterChanged(); })"
                                      Variant="Variant.Outlined"
                                      Clearable="true"
                                      Immediate="true">
                                <MudSelectItem T="int?" Value="null">Todas</MudSelectItem>
                                @foreach (var station in _stations)
                                {
                                    <MudSelectItem T="int?" Value="@station.StationId">
                                        @station.StationName, @station.City, @station.Province, @station.Country
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDateRangePicker DateRange="_filterDepartureDateRange" DateRangeChanged="@(async (DateRange? range) => { _filterDepartureDateRange = range; await OnFilterChanged(); })" Label="Rango Fecha Salida" Variant="Variant.Outlined" Clearable="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDateRangePicker DateRange="_filterArrivalDateRange" DateRangeChanged="@(async (DateRange? range) => { _filterArrivalDateRange = range; await OnFilterChanged(); })" Label="Rango Fecha Llegada" Variant="Variant.Outlined" Clearable="true" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">Limpiar Filtros</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>
            <MudDataGrid @ref="dataGrid"
                         T="UserReservationDetailsDto"
                         ServerData="ServerReload"
                         RowsPerPage="10">
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString"
                                  Placeholder="Buscar en todos los campos"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  IconSize="Size.Medium"
                                  Class="mt-0"
                                  Clearable="true"
                                  OnClearButtonClick="@(() => { _searchString = string.Empty; dataGrid.ReloadServerData(); })"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  OnDebounceIntervalElapsed="@(() => dataGrid.ReloadServerData())" />
                </ToolBarContent>
                <Columns>
                    <PropertyColumn Property="x => x.TripId" Title="Viaje" />
                    <TemplateColumn Title="Salida">
                        <CellTemplate>
                            <div>
                                <b>@context.Item.DepartureStationName</b><br />
                                @context.Item.DepartureCity, @context.Item.DepartureProvince, @context.Item.DepartureCountry<br />
                                <span>@context.Item.DepartureTime.ToString("g")</span>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Llegada">
                        <CellTemplate>
                            <div>
                                <b>@context.Item.ArrivalStationName</b><br />
                                @context.Item.ArrivalCity, @context.Item.ArrivalProvince, @context.Item.ArrivalCountry<br />
                                <span>@context.Item.ArrivalTime.ToString("g")</span>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Seat" Title="Asiento" />
                    <TemplateColumn>
                        <CellTemplate>
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDelete(context.Item))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="UserReservationDetailsDto" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private MudDataGrid<UserReservationDetailsDto> dataGrid = null!;
    private string _searchString = string.Empty;
    private int? _filterDepartureStationId = null;
    private int? _filterArrivalStationId = null;
    private DateRange? _filterDepartureDateRange = null;
    private DateRange? _filterArrivalDateRange = null;
    private List<Station> _stations = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _stations = (await StationService.GetAllStationsAsync()).ToList();
        }
        catch
        {
            Snackbar.Add("Error al cargar las estaciones.", Severity.Error);
        }
    }

    private async Task<GridData<UserReservationDetailsDto>> ServerReload(GridState<UserReservationDetailsDto> state)
    {
        try
        {
            var searchRequest = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize,
                Filters = BuildFilters(),
                Orders = []
            };
            var result = await ClientReservationService.SearchCurrentUserReservationsAsync(searchRequest);
            return new GridData<UserReservationDetailsDto> { Items = result.Items, TotalItems = result.TotalCount };
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error al cargar reservas.", Severity.Error);
        }
        return new GridData<UserReservationDetailsDto> { Items = Array.Empty<UserReservationDetailsDto>(), TotalItems = 0 };
    }

    private IList<Filter> BuildFilters()
    {
        List<Filter> filters = [];
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            filters.Add(new Filter("DepartureStationName", AppFilterOperator.Contains, _searchString));
            filters.Add(new Filter("ArrivalStationName", AppFilterOperator.Contains, _searchString));
        }
        else
        {
            if (_filterDepartureStationId.HasValue)
                filters.Add(new Filter("DepartureStationId", AppFilterOperator.Equals, _filterDepartureStationId.Value));
            if (_filterArrivalStationId.HasValue)
                filters.Add(new Filter("ArrivalStationId", AppFilterOperator.Equals, _filterArrivalStationId.Value));
            if (_filterDepartureDateRange?.Start != null && _filterDepartureDateRange?.End != null)
                filters.Add(new Filter("DepartureTime", AppFilterOperator.Between, new object[] { _filterDepartureDateRange.Start, _filterDepartureDateRange.End }));
            if (_filterArrivalDateRange?.Start != null && _filterArrivalDateRange?.End != null)
                filters.Add(new Filter("ArrivalTime", AppFilterOperator.Between, new object[] { _filterArrivalDateRange.Start, _filterArrivalDateRange.End }));
        }
        return filters;
    }

    private void ClearFilters()
    {
        _filterDepartureStationId = null;
        _filterArrivalStationId = null;
        _filterDepartureDateRange = null;
        _filterArrivalDateRange = null;
        _searchString = string.Empty;
        dataGrid!.ReloadServerData();
    }

    private async Task OnFilterChanged()
    {
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            _searchString = string.Empty;
        }
        await dataGrid!.ReloadServerData();
    }

    private async Task HandleDelete(UserReservationDetailsDto item)
    {
        try
        {
            await ClientReservationService.DeleteReservationAsync(new ReservationKeyDto { TripId = item.TripId, Seat = item.Seat });
            Snackbar.Add("Reserva eliminada.", Severity.Success);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await dataGrid.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch
        {
            Snackbar.Add("Error inesperado.", Severity.Error);
        }
    }
}
