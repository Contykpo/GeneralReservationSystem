@page "/trips"

@attribute [Authorize]

@using FluentValidation
@using GeneralReservationSystem.Application.Common
@using GeneralReservationSystem.Application.DTOs
@using GeneralReservationSystem.Application.Entities
@using GeneralReservationSystem.Application.Exceptions.Services
@using GeneralReservationSystem.Application.Services.Interfaces
@using GeneralReservationSystem.Application.Validators
@using GeneralReservationSystem.Web.Client.Helpers
@using GeneralReservationSystem.Web.Client.Exceptions
@using Microsoft.AspNetCore.Authorization

@using AppFilterOperator = GeneralReservationSystem.Application.Common.FilterOperator
@using Severity = MudBlazor.Severity

@inject ITripService TripService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IStationService StationService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <PageTitle>Viajes</PageTitle>

    <AuthorizeView Roles="Admin">
        <Authorized>
            <MudExpansionPanels Class="mb-4">
                <MudExpansionPanel Text="Agregar nuevo viaje" Icon="@Icons.Material.Filled.Add">
                    <MudCard Class="pd-2">
                        <MudCardContent>
                            <MudForm @ref="_createForm" Model="@_createTripDto" Validation="@(_createTripDtoValidator.ValidateValue)" ValidationDelay="0" Spacing="3">
                                <MudSelect T="int" Label="Estación de salida"
                                          @bind-Value="_createTripDto.DepartureStationId"
                                          For="@(() => _createTripDto.DepartureStationId)"
                                          Variant="Variant.Outlined"
                                          Immediate="true">
                                    <MudSelectItem T="int" Value="0" Disabled="true">Seleccione una estación</MudSelectItem>
                                    @foreach (var station in _stations)
                                    {
                                        <MudSelectItem T="int" Value="@station.StationId">
                                            @station.StationName, @station.City, @station.Region, @station.Country
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                                <MudDatePicker Label="Fecha de salida" 
                                               Date="_createTripDto.DepartureTime" 
                                               DateChanged="OnCreateDepartureDateChanged"
                                               DateFormat="dd/MM/yyyy" 
                                               Variant="Variant.Outlined" />
                                <MudTimePicker Label="Hora de salida" 
                                               Time="_createTripDto.DepartureTime.TimeOfDay" 
                                               TimeChanged="OnCreateDepartureTimeChanged"
                                               TimeFormat="HH:mm" 
                                               Variant="Variant.Outlined" />
                                <MudSelect T="int" Label="Estación de llegada"
                                          @bind-Value="_createTripDto.ArrivalStationId"
                                          For="@(() => _createTripDto.ArrivalStationId)"
                                          Variant="Variant.Outlined"
                                           Immediate="true">
                                    <MudSelectItem T="int" Value="0" Disabled="true">Seleccione una estación</MudSelectItem>
                                    @foreach (var station in _stations)
                                    {
                                        <MudSelectItem T="int" Value="@station.StationId">
                                            @station.StationName, @station.City, @station.Region, @station.Country
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                                <MudDatePicker Label="Fecha de llegada" 
                                               Date="_createTripDto.ArrivalTime" 
                                               DateChanged="OnCreateArrivalDateChanged"
                                               DateFormat="dd/MM/yyyy" 
                                               Variant="Variant.Outlined" />
                                <MudTimePicker Label="Hora de llegada" 
                                               Time="_createTripDto.ArrivalTime.TimeOfDay" 
                                               TimeChanged="OnCreateArrivalTimeChanged"
                                               TimeFormat="HH:mm" 
                                               Variant="Variant.Outlined" />
                                <MudNumericField Label="Asientos disponibles" 
                                                 For="@(() => _createTripDto.AvailableSeats)" 
                                                 @bind-Value="_createTripDto.AvailableSeats" 
                                                 Variant="Variant.Outlined" 
                                                 Immediate="true" />
                            </MudForm>
                        </MudCardContent>
                        <MudCardActions Class="gap-2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleCreate" StartIcon="@Icons.Material.Filled.Save">Guardar</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearForm">Limpiar</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </Authorized>
    </AuthorizeView>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Viajes</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => _table!.ReloadServerData())" StartIcon="@Icons.Material.Filled.Refresh">Actualizar</MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel Text="Filtros avanzados" Icon="@Icons.Material.Filled.FilterList">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="int?" Label="Estación de salida"
                                      Value="_filterDepartureStationId"
                                      ValueChanged="@(async (int? value) => { _filterDepartureStationId = value; await OnFilterChanged(); })"
                                      Variant="Variant.Outlined"
                                      Clearable="true"
                                      Immediate="true">
                                <MudSelectItem T="int?" Value="null">Todas</MudSelectItem>
                                @foreach (var station in _stations)
                                {
                                    <MudSelectItem T="int?" Value="@station.StationId">
                                        @station.StationName, @station.City, @station.Region, @station.Country
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="int?" Label="Estación de llegada"
                                      Value="_filterArrivalStationId"
                                      ValueChanged="@(async (int? value) => { _filterArrivalStationId = value; await OnFilterChanged(); })"
                                      Variant="Variant.Outlined"
                                      Clearable="true"
                                      Immediate="true">
                                <MudSelectItem T="int?" Value="null">Todas</MudSelectItem>
                                @foreach (var station in _stations)
                                {
                                    <MudSelectItem T="int?" Value="@station.StationId">
                                        @station.StationName, @station.City, @station.Region, @station.Country
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDatePicker Date="_filterDepartureDate"
                                           DateChanged="@(async (DateTime? date) => { _filterDepartureDate = date; await OnFilterChanged(); })"
                                           Label="Fecha de salida" 
                                           Variant="Variant.Outlined"
                                           Clearable="true"
                                           DateFormat="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudDatePicker Date="_filterArrivalDate"
                                           DateChanged="@(async (DateTime? date) => { _filterArrivalDate = date; await OnFilterChanged(); })"
                                           Label="Fecha de llegada" 
                                           Variant="Variant.Outlined"
                                           Clearable="true"
                                           DateFormat="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">Limpiar Filtros</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudTable @ref="_table" 
                      T="TripWithDetailsDto" 
                      ServerData="ServerReload"
                      Loading="@_loading" 
                      LoadingProgressColor="Color.Primary"
                      Hover="true" 
                      Breakpoint="Breakpoint.Sm"
                      Dense="true"
                      RowsPerPage="10"
                      Elevation="0">
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString" 
                                  Placeholder="Buscar en todos los campos" 
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" 
                                  Class="mt-0"
                                  Clearable="true"
                                  OnClearButtonClick="@(() => { _searchString = string.Empty; _table!.ReloadServerData(); })"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  OnDebounceIntervalElapsed="@(async () => { await OnSearchChanged(); })"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortLabel="DepartureStationName" T="TripWithDetailsDto">Salida</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="DepartureTime" T="TripWithDetailsDto">Hora Salida</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="ArrivalStationName" T="TripWithDetailsDto">Llegada</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="ArrivalTime" T="TripWithDetailsDto">Hora Llegada</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortLabel="AvailableSeats" T="TripWithDetailsDto">Asientos</MudTableSortLabel></MudTh>
                    <MudTh>Reservados</MudTh>
                    <MudTh>Libres</MudTh>
                    <MudTh Style="text-align: right">Acciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Salida">
                        @context.DepartureStationName
                        <div class="mud-typography-caption">@context.DepartureCity, @context.DepartureRegion, @context.DepartureCountry</div>
                    </MudTd>
                    <MudTd DataLabel="Hora Salida">@context.DepartureTime.ToString("dd/MM/yyyy HH:mm")</MudTd>
                    <MudTd DataLabel="Llegada">
                        @context.ArrivalStationName
                        <div class="mud-typography-caption">@context.ArrivalCity, @context.ArrivalRegion, @context.ArrivalCountry</div>
                    </MudTd>
                    <MudTd DataLabel="Hora Llegada">@context.ArrivalTime.ToString("dd/MM/yyyy HH:mm")</MudTd>
                    <MudTd DataLabel="Asientos">@context.AvailableSeats</MudTd>
                    <MudTd DataLabel="Reservados">@context.ReservedSeats</MudTd>
                    <MudTd DataLabel="Libres">@context.FreeSeats</MudTd>
                    <MudTd DataLabel="Acciones" Style="text-align: right" Class="text-nowrap">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                   Disabled="@(context.FreeSeats == 0 || DateTime.Now >= context.DepartureTime)"
                                   OnClick="@(() => ReserveTrip(context.TripId))"
                                   StartIcon="@Icons.Material.Filled.EventSeat">
                            Reservar
                        </MudButton>
                        <AuthorizeView Roles="Admin" Context="authContext">
                            <Authorized>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditDialog(context))" />
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => HandleDelete(context))" />
                            </Authorized>
                        </AuthorizeView>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No se encontraron viajes.</MudText>
                </NoRecordsContent>
                <LoadingContent>
                    <MudText>Cargando...</MudText>
                </LoadingContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

<MudDialog @bind-Visible="_editDialogVisible" Options="_editDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3" /> Editar Viaje
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm Model="@_editTripDto" @ref="_updateForm" Validation="@(_updateTripDtoValidator.ValidateValue)" ValidationDelay="0">
            <MudSelect T="int?" Label="Estación de salida"
                      @bind-Value="_editTripDto.DepartureStationId"
                      For="@(() => _editTripDto.DepartureStationId)"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                       Immediate="true">
                <MudSelectItem T="int?" Value="null" Disabled="true">Seleccione una estación</MudSelectItem>
                @foreach (var station in _stations)
                {
                    <MudSelectItem T="int?" Value="@station.StationId">
                        @station.StationName, @station.City, @station.Region, @station.Country
                    </MudSelectItem>
                }
            </MudSelect>
            <MudDatePicker Label="Fecha de salida"
                           Date="_editTripDto.DepartureTime"
                           DateChanged="OnEditDepartureDateChanged"
                           DateFormat="dd/MM/yyyy"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense" />
            <MudTimePicker Label="Hora de salida"
                           Time="_editTripDto.DepartureTime?.TimeOfDay"
                           TimeChanged="OnEditDepartureTimeChanged"
                           TimeFormat="HH:mm"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense" />
            <MudSelect T="int?" Label="Estación de llegada"
                      @bind-Value="_editTripDto.ArrivalStationId"
                      For="@(() => _editTripDto.ArrivalStationId)"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                       Immediate="true">
                <MudSelectItem T="int?" Value="null" Disabled="true">Seleccione una estación</MudSelectItem>
                @foreach (var station in _stations)
                {
                    <MudSelectItem T="int?" Value="@station.StationId">
                        @station.StationName, @station.City, @station.Region, @station.Country
                    </MudSelectItem>
                }
            </MudSelect>
            <MudDatePicker Label="Fecha de llegada"
                           Date="_editTripDto.ArrivalTime"
                           DateChanged="OnEditArrivalDateChanged"
                           DateFormat="dd/MM/yyyy"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense" />
            <MudTimePicker Label="Hora de llegada"
                           Time="_editTripDto.ArrivalTime?.TimeOfDay"
                           TimeChanged="OnEditArrivalTimeChanged"
                           TimeFormat="HH:mm"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense" />
            <MudNumericField Label="Asientos disponibles"
                             @bind-Value="_editTripDto.AvailableSeats" 
                             For="@(() => _editTripDto.AvailableSeats)"
                             Variant="Variant.Outlined" 
                             Margin="Margin.Dense" 
                             Immediate="true" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEditDialog" Variant="Variant.Outlined">Cancelar</MudButton>
        <MudButton OnClick="HandleUpdate" Variant="Variant.Filled" Color="Color.Primary">Guardar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudTable<TripWithDetailsDto> _table = null!;
    private bool _loading = false;
    private string _searchString = string.Empty;
    
    // Advanced filters
    private int? _filterDepartureStationId = null;
    private int? _filterArrivalStationId = null;
    private DateTime? _filterDepartureDate = null;
    private DateTime? _filterArrivalDate = null;

    private MudForm _createForm = null!;
    private static DateTime DefaultDepartureDate => DateTime.Now;
    private static DateTime DefaultArrivalDate => DateTime.Now.AddHours(12);
    private CreateTripDto _createTripDto = new()
    {
        DepartureTime = DefaultDepartureDate,
        ArrivalTime = DefaultArrivalDate
    };
    private CreateTripDtoValidator _createTripDtoValidator = new();

    private MudForm _updateForm = null!;
    private UpdateTripDto _editTripDto = new()
    {
        DepartureTime = DefaultDepartureDate,
        ArrivalTime = DefaultArrivalDate
    };
    private UpdateTripDtoValidator _updateTripDtoValidator = new();

    private bool _editDialogVisible = false;
    private DialogOptions _editDialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseButton = true,
        Position = DialogPosition.Center,
        CloseOnEscapeKey = true
    };

    private List<Station> _stations = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _stations = (await StationService.GetAllStationsAsync()).ToList();
        }
        catch
        {
            Snackbar.Add("Error al cargar las estaciones.", Severity.Error);
        }
    }

    private async Task<TableData<TripWithDetailsDto>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var searchRequest = new PagedSearchRequestDto
            {
                Page = state.Page + 1,
                PageSize = state.PageSize,
                Filters = BuildFilters(state),
                Orders = TableHelpers.BuildOrders(state)
            };

            var result = await TripService.SearchTripsAsync(searchRequest, cancellationToken);
            return new TableData<TripWithDetailsDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Ocurrió un error al cargar los viajes.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }

        return new TableData<TripWithDetailsDto> { Items = Array.Empty<TripWithDetailsDto>(), TotalItems = 0 };
    }

    private IList<Filter> BuildFilters(TableState state)
    {
        List<Filter> filters = new List<Filter>();

        // Global search filter
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            if (int.TryParse(_searchString, out var numericValue))
            {
                filters.Add(new Filter("TripId", AppFilterOperator.Equals, numericValue));
                filters.Add(new Filter("DepartureStationId", AppFilterOperator.Equals, numericValue));
                filters.Add(new Filter("ArrivalStationId", AppFilterOperator.Equals, numericValue));
                filters.Add(new Filter("AvailableSeats", AppFilterOperator.Equals, numericValue));
            }
            else
            {
                // Search text across station names and locations
                filters.Add(new Filter("DepartureStationName", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("DepartureCity", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("DepartureRegion", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("DepartureCountry", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("ArrivalStationName", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("ArrivalCity", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("ArrivalRegion", AppFilterOperator.Contains, _searchString));
                filters.Add(new Filter("ArrivalCountry", AppFilterOperator.Contains, _searchString));
            }
        }
        // Advanced filters
        else
        {
            if (_filterDepartureStationId.HasValue)
            {
                filters.Add(new Filter("DepartureStationId", AppFilterOperator.Equals, _filterDepartureStationId.Value));
            }
            
            if (_filterArrivalStationId.HasValue)
            {
                filters.Add(new Filter("ArrivalStationId", AppFilterOperator.Equals, _filterArrivalStationId.Value));
            }
            
            if (_filterDepartureDate.HasValue)
            {
                filters.Add(new Filter("DepartureTime", AppFilterOperator.GreaterThanOrEqual, _filterDepartureDate.Value.Date));
                filters.Add(new Filter("DepartureTime", AppFilterOperator.LessThan, _filterDepartureDate.Value.Date.AddDays(1)));
            }
            
            if (_filterArrivalDate.HasValue)
            {
                filters.Add(new Filter("ArrivalTime", AppFilterOperator.GreaterThanOrEqual, _filterArrivalDate.Value.Date));
                filters.Add(new Filter("ArrivalTime", AppFilterOperator.LessThan, _filterArrivalDate.Value.Date.AddDays(1)));
            }
        }

        return filters;
    }

    private void ClearFilters()
    {
        _filterDepartureStationId = null;
        _filterArrivalStationId = null;
        _filterDepartureDate = null;
        _filterArrivalDate = null;
        _searchString = string.Empty;
        _table!.ReloadServerData();
    }

    private async Task OnFilterChanged()
    {
        // Clear search string when using advanced filters
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            _searchString = string.Empty;
        }
        await _table!.ReloadServerData();
    }

    private async Task OnSearchChanged()
    {
        // Clear advanced filters when using search
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            _filterDepartureStationId = null;
            _filterArrivalStationId = null;
            _filterDepartureDate = null;
            _filterArrivalDate = null;
        }
        await _table!.ReloadServerData();
    }

    private async Task HandleCreate()
    {
        try
        {
            if (_createForm is not null)
            {
                await _createForm.Validate();
                if (!_createForm.IsValid) return;
            }

            await TripService.CreateTripAsync(_createTripDto);
            Snackbar.Add("Viaje creado correctamente.", Severity.Success);
            ClearForm();
            await _table.ReloadServerData();
        }
        catch (ServiceValidationException ex)
        {
            foreach (var error in ex.Errors)
            {
                Snackbar.Add(error.Message, Severity.Error);
            }
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error inesperado al crear el viaje.", Severity.Error);
        }
    }

    private void OpenEditDialog(TripWithDetailsDto trip)
    {
        _editTripDto = new UpdateTripDto
        {
            TripId = trip.TripId,
            DepartureStationId = trip.DepartureStationId,
            DepartureTime = trip.DepartureTime,
            ArrivalStationId = trip.ArrivalStationId,
            ArrivalTime = trip.ArrivalTime,
            AvailableSeats = trip.AvailableSeats
        };
        _updateForm?.ResetValidation();
        _editDialogVisible = true;
    }

    private void CloseEditDialog()
    {
        _editDialogVisible = false;
        _editTripDto = new UpdateTripDto()
        {
            DepartureTime = DefaultDepartureDate,
            ArrivalTime = DefaultArrivalDate
        };
        _updateForm?.ResetValidation();
    }

    private async Task HandleUpdate()
    {
        try
        {
            if (_updateForm is not null)
            {
                await _updateForm.Validate();
                if (!_updateForm.IsValid)
                    return;
            }

            await TripService.UpdateTripAsync(_editTripDto);
            Snackbar.Add("Viaje actualizado correctamente.", Severity.Success);
            CloseEditDialog();
            await _table.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            CloseEditDialog();
            await _table.ReloadServerData();
        }
        catch (ServiceValidationException ex)
        {
            foreach (var error in ex.Errors)
            {
                Snackbar.Add(error.Message, Severity.Error);
            }
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error inesperado al actualizar el viaje.", Severity.Error);
        }
    }

    private async Task HandleDelete(TripWithDetailsDto item)
    {
        try
        {
            await TripService.DeleteTripAsync(new TripKeyDto { TripId = item.TripId });
            Snackbar.Add("Viaje eliminado correctamente.", Severity.Success);
            await _table.ReloadServerData();
        }
        catch (ServiceNotFoundException ex)
        {
            Snackbar.Add(ex.Message, Severity.Warning);
            await _table.ReloadServerData();
        }
        catch (ServiceBusinessException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (ServiceException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception)
        {
            Snackbar.Add("Error inesperado al eliminar el viaje.", Severity.Error);
        }
    }

    private void ClearForm()
    {
        _createTripDto = new()
        {
            DepartureTime = DefaultDepartureDate,
            ArrivalTime = DefaultArrivalDate
        };
        _createForm?.ResetValidation();
    }

    // Create form handlers
    private async void OnCreateDepartureDateChanged(DateTime? date)
    {
        _createTripDto.DepartureTime = Combine(date, _createTripDto.DepartureTime.TimeOfDay);
        if (_createForm is not null)
        {
            await _createForm.Validate();
        }
        StateHasChanged();
    }

    private async void OnCreateDepartureTimeChanged(TimeSpan? time)
    {
        _createTripDto.DepartureTime = Combine(_createTripDto.DepartureTime.Date, time);
        if (_createForm is not null)
        {
            await _createForm.Validate();
        }
        StateHasChanged();
    }

    private async void OnCreateArrivalDateChanged(DateTime? date)
    {
        _createTripDto.ArrivalTime = Combine(date, _createTripDto.ArrivalTime.TimeOfDay);
        if (_createForm is not null)
        {
            await _createForm.Validate();
        }
        StateHasChanged();
    }

    private async void OnCreateArrivalTimeChanged(TimeSpan? time)
    {
        _createTripDto.ArrivalTime = Combine(_createTripDto.ArrivalTime.Date, time);
        if (_createForm is not null)
        {
            await _createForm.Validate();
        }
        StateHasChanged();
    }

    // Edit form handlers
    private async void OnEditDepartureDateChanged(DateTime? date)
    {
        _editTripDto.DepartureTime = Combine(date, _editTripDto.DepartureTime?.TimeOfDay);
        if (_updateForm is not null)
        {
            await _updateForm.Validate();
        }
        StateHasChanged();
    }

    private async void OnEditDepartureTimeChanged(TimeSpan? time)
    {
        _editTripDto.DepartureTime = Combine(_editTripDto.DepartureTime?.Date, time);
        if (_updateForm is not null)
        {
            await _updateForm.Validate();
        }
        StateHasChanged();
    }

    private async void OnEditArrivalDateChanged(DateTime? date)
    {
        _editTripDto.ArrivalTime = Combine(date, _editTripDto.ArrivalTime?.TimeOfDay);
        if (_updateForm is not null)
        {
            await _updateForm.Validate();
        }
        StateHasChanged();
    }

    private async void OnEditArrivalTimeChanged(TimeSpan? time)
    {
        _editTripDto.ArrivalTime = Combine(_editTripDto.ArrivalTime?.Date, time);
        if (_updateForm is not null)
        {
            await _updateForm.Validate();
        }
        StateHasChanged();
    }

    private static DateTime Combine(DateTime? date, TimeSpan? time)
    {
        var d = date ?? DateTime.Today;
        var t = time ?? TimeSpan.Zero;
        return d.Date + t;
    }

    private void ReserveTrip(int tripId)
    {
        Navigation.NavigateTo($"/trips/reserve/{tripId}");
    }
}
